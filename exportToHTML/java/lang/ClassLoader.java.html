<html>
<head>
<title>ClassLoader.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #5f826b; font-style: italic;}
.s5 { color: #67a37c; font-style: italic;}
.s6 { color: #68a67e; font-style: italic;}
.s7 { color: #2aacb8;}
.s8 { color: #6aab73;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ClassLoader.java</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) 2013, 2023, Oracle and/or its affiliates. All rights reserved. 
 * Copyright (c) 2019, Azul Systems, Inc. All rights reserved. 
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER. 
 * 
 * This code is free software; you can redistribute it and/or modify it 
 * under the terms of the GNU General Public License version 2 only, as 
 * published by the Free Software Foundation.  Oracle designates this 
 * particular file as subject to the &quot;Classpath&quot; exception as provided 
 * by Oracle in the LICENSE file that accompanied this code. 
 * 
 * This code is distributed in the hope that it will be useful, but WITHOUT 
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or 
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License 
 * version 2 for more details (a copy is included in the LICENSE file that 
 * accompanied this code). 
 * 
 * You should have received a copy of the GNU General Public License version 
 * 2 along with this work; if not, write to the Free Software Foundation, 
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA. 
 * 
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA 
 * or visit www.oracle.com if you need additional information or have any 
 * questions. 
 */</span>

<span class="s2">package </span><span class="s1">java</span><span class="s3">.</span><span class="s1">lang</span><span class="s3">;</span>

<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">InputStream</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">IOException</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">UncheckedIOException</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">io</span><span class="s3">.</span><span class="s1">File</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">lang</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">.</span><span class="s1">Constructor</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">lang</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">.</span><span class="s1">InvocationTargetException</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">net</span><span class="s3">.</span><span class="s1">URL</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">security</span><span class="s3">.</span><span class="s1">AccessController</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">security</span><span class="s3">.</span><span class="s1">AccessControlContext</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">security</span><span class="s3">.</span><span class="s1">CodeSource</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">security</span><span class="s3">.</span><span class="s1">PrivilegedAction</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">security</span><span class="s3">.</span><span class="s1">ProtectionDomain</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">security</span><span class="s3">.</span><span class="s1">cert</span><span class="s3">.</span><span class="s1">Certificate</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">ArrayList</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">Collections</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">Enumeration</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">HashMap</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">Map</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">NoSuchElementException</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">Objects</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">Set</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">Spliterator</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">Spliterators</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">WeakHashMap</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">concurrent</span><span class="s3">.</span><span class="s1">ConcurrentHashMap</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">function</span><span class="s3">.</span><span class="s1">Supplier</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">Stream</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">java</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">.</span><span class="s1">StreamSupport</span><span class="s3">;</span>

<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">loader</span><span class="s3">.</span><span class="s1">BootLoader</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">loader</span><span class="s3">.</span><span class="s1">BuiltinClassLoader</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">loader</span><span class="s3">.</span><span class="s1">ClassLoaders</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">loader</span><span class="s3">.</span><span class="s1">NativeLibrary</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">loader</span><span class="s3">.</span><span class="s1">NativeLibraries</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">perf</span><span class="s3">.</span><span class="s1">PerfCounter</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">Unsafe</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">VM</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">.</span><span class="s1">CallerSensitive</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">.</span><span class="s1">CallerSensitiveAdapter</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">.</span><span class="s1">Reflection</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">jdk</span><span class="s3">.</span><span class="s1">internal</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">StaticProperty</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">sun</span><span class="s3">.</span><span class="s1">reflect</span><span class="s3">.</span><span class="s1">misc</span><span class="s3">.</span><span class="s1">ReflectUtil</span><span class="s3">;</span>
<span class="s2">import </span><span class="s1">sun</span><span class="s3">.</span><span class="s1">security</span><span class="s3">.</span><span class="s1">util</span><span class="s3">.</span><span class="s1">SecurityConstants</span><span class="s3">;</span>

<span class="s4">/**</span>
 <span class="s4">* A class loader is an object that is responsible for loading classes. The</span>
 <span class="s4">* class {</span><span class="s5">@code </span><span class="s4">ClassLoader} is an abstract class.  Given the </span><span class="s6">&lt;a</span>
 <span class="s4">* href=&quot;#binary-name&quot;&gt;binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of a class, a class loader should attempt to</span>
 <span class="s4">* locate or generate data that constitutes a definition for the class.  A</span>
 <span class="s4">* typical strategy is to transform the name into a file name and then read a</span>
 <span class="s4">* &quot;class file&quot; of that name from a file system.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Every {</span><span class="s5">@link </span><span class="s4">java.lang.Class Class} object contains a {</span><span class="s5">@link</span>
 <span class="s4">* Class#getClassLoader() reference} to the {</span><span class="s5">@code </span><span class="s4">ClassLoader} that defined</span>
 <span class="s4">* it.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">{</span><span class="s5">@code </span><span class="s4">Class} objects for array classes are not created by class</span>
 <span class="s4">* loaders, but are created automatically as required by the Java runtime.</span>
 <span class="s4">* The class loader for an array class, as returned by {</span><span class="s5">@link</span>
 <span class="s4">* Class#getClassLoader()} is the same as the class loader for its element</span>
 <span class="s4">* type; if the element type is a primitive type, then the array class has no</span>
 <span class="s4">* class loader.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Applications implement subclasses of {</span><span class="s5">@code </span><span class="s4">ClassLoader} in order to</span>
 <span class="s4">* extend the manner in which the Java virtual machine dynamically loads</span>
 <span class="s4">* classes.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Class loaders may typically be used by security managers to indicate</span>
 <span class="s4">* security domains.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">In addition to loading classes, a class loader is also responsible for</span>
 <span class="s4">* locating resources. A resource is some data (a &quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot; file,</span>
 <span class="s4">* configuration data, or an image for example) that is identified with an</span>
 <span class="s4">* abstract '/'-separated path name. Resources are typically packaged with an</span>
 <span class="s4">* application or library so that they can be located by code in the</span>
 <span class="s4">* application or library. In some cases, the resources are included so that</span>
 <span class="s4">* they can be located by other libraries.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">ClassLoader} class uses a delegation model to search for</span>
 <span class="s4">* classes and resources.  Each instance of {</span><span class="s5">@code </span><span class="s4">ClassLoader} has an</span>
 <span class="s4">* associated parent class loader. When requested to find a class or</span>
 <span class="s4">* resource, a {</span><span class="s5">@code </span><span class="s4">ClassLoader} instance will usually delegate the search</span>
 <span class="s4">* for the class or resource to its parent class loader before attempting to</span>
 <span class="s4">* find the class or resource itself.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Class loaders that support concurrent loading of classes are known as</span>
 <span class="s4">* </span><span class="s6">&lt;em&gt;</span><span class="s4">{</span><span class="s5">@linkplain </span><span class="s4">#isRegisteredAsParallelCapable() parallel capable}</span><span class="s6">&lt;/em&gt; </span><span class="s4">class</span>
 <span class="s4">* loaders and are required to register themselves at their class initialization</span>
 <span class="s4">* time by invoking the {</span><span class="s5">@link</span>
 <span class="s4">* #registerAsParallelCapable ClassLoader.registerAsParallelCapable}</span>
 <span class="s4">* method. Note that the {</span><span class="s5">@code </span><span class="s4">ClassLoader} class is registered as parallel</span>
 <span class="s4">* capable by default. However, its subclasses still need to register themselves</span>
 <span class="s4">* if they are parallel capable.</span>
 <span class="s4">* In environments in which the delegation model is not strictly</span>
 <span class="s4">* hierarchical, class loaders need to be parallel capable, otherwise class</span>
 <span class="s4">* loading can lead to deadlocks because the loader lock is held for the</span>
 <span class="s4">* duration of the class loading process (see {</span><span class="s5">@link </span><span class="s4">#loadClass</span>
 <span class="s4">* loadClass} methods).</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;h2&gt; &lt;a id=&quot;builtinLoaders&quot;&gt;</span><span class="s4">Run-time Built-in Class Loaders</span><span class="s6">&lt;/a&gt;&lt;/h2&gt;</span>
 <span class="s4">*</span>
 <span class="s4">* The Java run-time has the following built-in class loaders:</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;ul&gt;</span>
 <span class="s4">* </span><span class="s6">&lt;li&gt;&lt;p&gt;</span><span class="s4">Bootstrap class loader.</span>
 <span class="s4">*     It is the virtual machine's built-in class loader, typically represented</span>
 <span class="s4">*     as {</span><span class="s5">@code </span><span class="s4">null}, and does not have a parent.</span><span class="s6">&lt;/li&gt;</span>
 <span class="s4">* </span><span class="s6">&lt;li&gt;&lt;p&gt;</span><span class="s4">{</span><span class="s5">@linkplain </span><span class="s4">#getPlatformClassLoader() Platform class loader}.</span>
 <span class="s4">*     The platform class loader is responsible for loading the</span>
 <span class="s4">*     </span><span class="s6">&lt;em&gt;</span><span class="s4">platform classes</span><span class="s6">&lt;/em&gt;</span><span class="s4">.  Platform classes include Java SE platform APIs,</span>
 <span class="s4">*     their implementation classes and JDK-specific run-time classes that are</span>
 <span class="s4">*     defined by the platform class loader or its ancestors.</span>
 <span class="s4">*     The platform class loader can be used as the parent of a {</span><span class="s5">@code </span><span class="s4">ClassLoader}</span>
 <span class="s4">*     instance.</span>
 <span class="s4">*     </span><span class="s6">&lt;p&gt; </span><span class="s4">To allow for upgrading/overriding of modules defined to the platform</span>
 <span class="s4">*     class loader, and where upgraded modules read modules defined to class</span>
 <span class="s4">*     loaders other than the platform class loader and its ancestors, then</span>
 <span class="s4">*     the platform class loader may have to delegate to other class loaders,</span>
 <span class="s4">*     the application class loader for example.</span>
 <span class="s4">*     In other words, classes in named modules defined to class loaders</span>
 <span class="s4">*     other than the platform class loader and its ancestors may be visible</span>
 <span class="s4">*     to the platform class loader. </span><span class="s6">&lt;/li&gt;</span>
 <span class="s4">* </span><span class="s6">&lt;li&gt;&lt;p&gt;</span><span class="s4">{</span><span class="s5">@linkplain </span><span class="s4">#getSystemClassLoader() System class loader}.</span>
 <span class="s4">*     It is also known as </span><span class="s6">&lt;em&gt;</span><span class="s4">application class loader</span><span class="s6">&lt;/em&gt; </span><span class="s4">and is distinct</span>
 <span class="s4">*     from the platform class loader.</span>
 <span class="s4">*     The system class loader is typically used to define classes on the</span>
 <span class="s4">*     application class path, module path, and JDK-specific tools.</span>
 <span class="s4">*     The platform class loader is the parent or an ancestor of the system class</span>
 <span class="s4">*     loader, so the system class loader can load platform classes by delegating</span>
 <span class="s4">*     to its parent.</span><span class="s6">&lt;/li&gt;</span>
 <span class="s4">* </span><span class="s6">&lt;/ul&gt;</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Normally, the Java virtual machine loads classes from the local file</span>
 <span class="s4">* system in a platform-dependent manner.</span>
 <span class="s4">* However, some classes may not originate from a file; they may originate</span>
 <span class="s4">* from other sources, such as the network, or they could be constructed by an</span>
 <span class="s4">* application.  The method {</span><span class="s5">@link </span><span class="s4">#defineClass(String, byte[], int, int)</span>
 <span class="s4">* defineClass} converts an array of bytes into an instance of class</span>
 <span class="s4">* {</span><span class="s5">@code </span><span class="s4">Class}. Instances of this newly defined class can be created using</span>
 <span class="s4">* {</span><span class="s5">@link </span><span class="s4">Class#newInstance Class.newInstance}.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The methods and constructors of objects created by a class loader may</span>
 <span class="s4">* reference other classes.  To determine the class(es) referred to, the Java</span>
 <span class="s4">* virtual machine invokes the {</span><span class="s5">@link </span><span class="s4">#loadClass loadClass} method of</span>
 <span class="s4">* the class loader that originally created the class.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">For example, an application could create a network class loader to</span>
 <span class="s4">* download class files from a server.  Sample code might look like:</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;blockquote&gt;&lt;pre&gt;</span>
 <span class="s4">*   ClassLoader loader</span><span class="s6">&amp;nbsp;</span><span class="s4">= new NetworkClassLoader(host,</span><span class="s6">&amp;nbsp;</span><span class="s4">port);</span>
 <span class="s4">*   Object main</span><span class="s6">&amp;nbsp;</span><span class="s4">= loader.loadClass(&quot;Main&quot;, true).newInstance();</span>
 <span class="s4">*       </span><span class="s6">&amp;nbsp;</span><span class="s4">.</span><span class="s6">&amp;nbsp;</span><span class="s4">.</span><span class="s6">&amp;nbsp;</span><span class="s4">.</span>
 <span class="s4">* </span><span class="s6">&lt;/pre&gt;&lt;/blockquote&gt;</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The network class loader subclass must define the methods {</span><span class="s5">@link</span>
 <span class="s4">* #findClass findClass} and {</span><span class="s5">@code </span><span class="s4">loadClassData} to load a class</span>
 <span class="s4">* from the network.  Once it has downloaded the bytes that make up the class,</span>
 <span class="s4">* it should use the method {</span><span class="s5">@link </span><span class="s4">#defineClass defineClass} to</span>
 <span class="s4">* create a class instance.  A sample implementation is:</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;blockquote&gt;&lt;pre&gt;</span>
 <span class="s4">*     class NetworkClassLoader extends ClassLoader {</span>
 <span class="s4">*         String host;</span>
 <span class="s4">*         int port;</span>
 <span class="s4">*</span>
 <span class="s4">*         public Class findClass(String name) {</span>
 <span class="s4">*             byte[] b = loadClassData(name);</span>
 <span class="s4">*             return defineClass(name, b, 0, b.length);</span>
 <span class="s4">*         }</span>
 <span class="s4">*</span>
 <span class="s4">*         private byte[] loadClassData(String name) {</span>
 <span class="s4">*             // load the class data from the connection</span>
 <span class="s4">*             </span><span class="s6">&amp;nbsp;</span><span class="s4">.</span><span class="s6">&amp;nbsp;</span><span class="s4">.</span><span class="s6">&amp;nbsp;</span><span class="s4">.</span>
 <span class="s4">*         }</span>
 <span class="s4">*     }</span>
 <span class="s4">* </span><span class="s6">&lt;/pre&gt;&lt;/blockquote&gt;</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;h3&gt; &lt;a id=&quot;binary-name&quot;&gt;</span><span class="s4">Binary names</span><span class="s6">&lt;/a&gt; &lt;/h3&gt;</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Any class name provided as a {</span><span class="s5">@code </span><span class="s4">String} parameter to methods in</span>
 <span class="s4">* {</span><span class="s5">@code </span><span class="s4">ClassLoader} must be a binary name as defined by</span>
 <span class="s4">* </span><span class="s6">&lt;cite&gt;</span><span class="s4">The Java Language Specification</span><span class="s6">&lt;/cite&gt;</span><span class="s4">.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Examples of valid class names include:</span>
 <span class="s4">* </span><span class="s6">&lt;blockquote&gt;&lt;pre&gt;</span>
 <span class="s4">*   &quot;java.lang.String&quot;</span>
 <span class="s4">*   &quot;javax.swing.JSpinner$DefaultEditor&quot;</span>
 <span class="s4">*   &quot;java.security.KeyStore$Builder$FileBuilder$1&quot;</span>
 <span class="s4">*   &quot;java.net.URLClassLoader$3$1&quot;</span>
 <span class="s4">* </span><span class="s6">&lt;/pre&gt;&lt;/blockquote&gt;</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Any package name provided as a {</span><span class="s5">@code </span><span class="s4">String} parameter to methods in</span>
 <span class="s4">* {</span><span class="s5">@code </span><span class="s4">ClassLoader} must be either the empty string (denoting an unnamed package)</span>
 <span class="s4">* or a fully qualified name as defined by</span>
 <span class="s4">* </span><span class="s6">&lt;cite&gt;</span><span class="s4">The Java Language Specification</span><span class="s6">&lt;/cite&gt;</span><span class="s4">.</span>
 <span class="s4">*</span>
 <span class="s4">* </span><span class="s5">@jls </span><span class="s4">6.7 Fully Qualified Names</span>
 <span class="s4">* </span><span class="s5">@jls </span><span class="s4">13.1 The Form of a Binary</span>
 <span class="s4">* </span><span class="s5">@see      </span><span class="s4">#resolveClass(Class)</span>
 <span class="s4">* </span><span class="s5">@since </span><span class="s4">1.0</span>
 <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
 <span class="s4">*/</span>
<span class="s2">public abstract class </span><span class="s1">ClassLoader </span><span class="s3">{</span>

    <span class="s2">private static native void </span><span class="s1">registerNatives</span><span class="s3">();</span>
    <span class="s2">static </span><span class="s3">{</span>
        <span class="s1">registerNatives</span><span class="s3">();</span>
    <span class="s3">}</span>

    <span class="s0">// The parent class loader for delegation</span>
    <span class="s0">// Note: VM hardcoded the offset of this field, thus all new fields</span>
    <span class="s0">// must be added *after* it.</span>
    <span class="s2">private final </span><span class="s1">ClassLoader parent</span><span class="s3">;</span>

    <span class="s0">// class loader name</span>
    <span class="s2">private final </span><span class="s1">String name</span><span class="s3">;</span>

    <span class="s0">// the unnamed module for this ClassLoader</span>
    <span class="s2">private final </span><span class="s1">Module unnamedModule</span><span class="s3">;</span>

    <span class="s0">// a string for exception message printing</span>
    <span class="s2">private final </span><span class="s1">String nameAndId</span><span class="s3">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Encapsulates the set of parallel capable loader types.</span>
     <span class="s4">*/</span>
    <span class="s2">private static class </span><span class="s1">ParallelLoaders </span><span class="s3">{</span>
        <span class="s2">private </span><span class="s1">ParallelLoaders</span><span class="s3">() {}</span>

        <span class="s0">// the set of parallel capable loader types</span>
        <span class="s2">private static final </span><span class="s1">Set</span><span class="s3">&lt;</span><span class="s1">Class</span><span class="s3">&lt;? </span><span class="s2">extends </span><span class="s1">ClassLoader</span><span class="s3">&gt;&gt; </span><span class="s1">loaderTypes </span><span class="s3">=</span>
            <span class="s1">Collections</span><span class="s3">.</span><span class="s1">newSetFromMap</span><span class="s3">(</span><span class="s2">new </span><span class="s1">WeakHashMap</span><span class="s3">&lt;&gt;());</span>
        <span class="s2">static </span><span class="s3">{</span>
            <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">loaderTypes</span><span class="s3">) { </span><span class="s1">loaderTypes</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">ClassLoader</span><span class="s3">.</span><span class="s2">class</span><span class="s3">); }</span>
        <span class="s3">}</span>

        <span class="s4">/**</span>
         <span class="s4">* Registers the given class loader type as parallel capable.</span>
         <span class="s4">* Returns {</span><span class="s5">@code </span><span class="s4">true} is successfully registered; {</span><span class="s5">@code </span><span class="s4">false} if</span>
         <span class="s4">* loader's super class is not registered.</span>
         <span class="s4">*/</span>
        <span class="s2">static boolean </span><span class="s1">register</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;? </span><span class="s2">extends </span><span class="s1">ClassLoader</span><span class="s3">&gt; </span><span class="s1">c</span><span class="s3">) {</span>
            <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">loaderTypes</span><span class="s3">) {</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">loaderTypes</span><span class="s3">.</span><span class="s1">contains</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">getSuperclass</span><span class="s3">())) {</span>
                    <span class="s0">// register the class loader as parallel capable</span>
                    <span class="s0">// if and only if all of its super classes are.</span>
                    <span class="s0">// Note: given current classloading sequence, if</span>
                    <span class="s0">// the immediate super class is parallel capable,</span>
                    <span class="s0">// all the super classes higher up must be too.</span>
                    <span class="s1">loaderTypes</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">c</span><span class="s3">);</span>
                    <span class="s2">return true</span><span class="s3">;</span>
                <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
                    <span class="s2">return false</span><span class="s3">;</span>
                <span class="s3">}</span>
            <span class="s3">}</span>
        <span class="s3">}</span>

        <span class="s4">/**</span>
         <span class="s4">* Returns {</span><span class="s5">@code </span><span class="s4">true} if the given class loader type is</span>
         <span class="s4">* registered as parallel capable.</span>
         <span class="s4">*/</span>
        <span class="s2">static boolean </span><span class="s1">isRegistered</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;? </span><span class="s2">extends </span><span class="s1">ClassLoader</span><span class="s3">&gt; </span><span class="s1">c</span><span class="s3">) {</span>
            <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">loaderTypes</span><span class="s3">) {</span>
                <span class="s2">return </span><span class="s1">loaderTypes</span><span class="s3">.</span><span class="s1">contains</span><span class="s3">(</span><span class="s1">c</span><span class="s3">);</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s0">// Maps class name to the corresponding lock object when the current</span>
    <span class="s0">// class loader is parallel capable.</span>
    <span class="s0">// Note: VM also uses this field to decide if the current class loader</span>
    <span class="s0">// is parallel capable and the appropriate lock object for class loading.</span>
    <span class="s2">private final </span><span class="s1">ConcurrentHashMap</span><span class="s3">&lt;</span><span class="s1">String</span><span class="s3">, </span><span class="s1">Object</span><span class="s3">&gt; </span><span class="s1">parallelLockMap</span><span class="s3">;</span>

    <span class="s0">// Maps packages to certs</span>
    <span class="s2">private final </span><span class="s1">ConcurrentHashMap</span><span class="s3">&lt;</span><span class="s1">String</span><span class="s3">, </span><span class="s1">Certificate</span><span class="s3">[]&gt; </span><span class="s1">package2certs</span><span class="s3">;</span>

    <span class="s0">// Shared among all packages with unsigned classes</span>
    <span class="s2">private static final </span><span class="s1">Certificate</span><span class="s3">[] </span><span class="s1">nocerts </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Certificate</span><span class="s3">[</span><span class="s7">0</span><span class="s3">];</span>

    <span class="s0">// The classes loaded by this class loader. The only purpose of this table</span>
    <span class="s0">// is to keep the classes from being GC'ed until the loader is GC'ed.</span>
    <span class="s2">private final </span><span class="s1">ArrayList</span><span class="s3">&lt;</span><span class="s1">Class</span><span class="s3">&lt;?&gt;&gt; </span><span class="s1">classes </span><span class="s3">= </span><span class="s2">new </span><span class="s1">ArrayList</span><span class="s3">&lt;&gt;();</span>

    <span class="s0">// The &quot;default&quot; domain. Set as the default ProtectionDomain on newly</span>
    <span class="s0">// created classes.</span>
    <span class="s2">private final </span><span class="s1">ProtectionDomain defaultDomain </span><span class="s3">=</span>
        <span class="s2">new </span><span class="s1">ProtectionDomain</span><span class="s3">(</span><span class="s2">new </span><span class="s1">CodeSource</span><span class="s3">(</span><span class="s2">null</span><span class="s3">, (</span><span class="s1">Certificate</span><span class="s3">[]) </span><span class="s2">null</span><span class="s3">),</span>
                             <span class="s2">null</span><span class="s3">, </span><span class="s2">this</span><span class="s3">, </span><span class="s2">null</span><span class="s3">);</span>

    <span class="s0">// Invoked by the VM to record every loaded class with this loader.</span>
    <span class="s2">void </span><span class="s1">addClass</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c</span><span class="s3">) {</span>
        <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">classes</span><span class="s3">) {</span>
            <span class="s1">classes</span><span class="s3">.</span><span class="s1">add</span><span class="s3">(</span><span class="s1">c</span><span class="s3">);</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s0">// The packages defined in this class loader.  Each package name is</span>
    <span class="s0">// mapped to its corresponding NamedPackage object.</span>
    <span class="s0">//</span>
    <span class="s0">// The value is a Package object if ClassLoader::definePackage,</span>
    <span class="s0">// Class::getPackage, ClassLoader::getDefinePackage(s) or</span>
    <span class="s0">// Package::getPackage(s) method is called to define it.</span>
    <span class="s0">// Otherwise, the value is a NamedPackage object.</span>
    <span class="s2">private final </span><span class="s1">ConcurrentHashMap</span><span class="s3">&lt;</span><span class="s1">String</span><span class="s3">, </span><span class="s1">NamedPackage</span><span class="s3">&gt; </span><span class="s1">packages</span>
            <span class="s3">= </span><span class="s2">new </span><span class="s1">ConcurrentHashMap</span><span class="s3">&lt;&gt;();</span>

    <span class="s0">/* 
     * Returns a named package for the given module. 
     */</span>
    <span class="s2">private </span><span class="s1">NamedPackage getNamedPackage</span><span class="s3">(</span><span class="s1">String pn</span><span class="s3">, </span><span class="s1">Module m</span><span class="s3">) {</span>
        <span class="s1">NamedPackage p </span><span class="s3">= </span><span class="s1">packages</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">pn</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">p </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">p </span><span class="s3">= </span><span class="s2">new </span><span class="s1">NamedPackage</span><span class="s3">(</span><span class="s1">pn</span><span class="s3">, </span><span class="s1">m</span><span class="s3">);</span>

            <span class="s1">NamedPackage value </span><span class="s3">= </span><span class="s1">packages</span><span class="s3">.</span><span class="s1">putIfAbsent</span><span class="s3">(</span><span class="s1">pn</span><span class="s3">, </span><span class="s1">p</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">value </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
                <span class="s0">// Package object already be defined for the named package</span>
                <span class="s1">p </span><span class="s3">= </span><span class="s1">value</span><span class="s3">;</span>
                <span class="s0">// if definePackage is called by this class loader to define</span>
                <span class="s0">// a package in a named module, this will return Package</span>
                <span class="s0">// object of the same name.  Package object may contain</span>
                <span class="s0">// unexpected information but it does not impact the runtime.</span>
                <span class="s0">// this assertion may be helpful for troubleshooting</span>
                <span class="s2">assert </span><span class="s1">value</span><span class="s3">.</span><span class="s1">module</span><span class="s3">() == </span><span class="s1">m</span><span class="s3">;</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">p</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">private static </span><span class="s1">Void checkCreateClassLoader</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">checkCreateClassLoader</span><span class="s3">(</span><span class="s2">null</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s2">private static </span><span class="s1">Void checkCreateClassLoader</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">name </span><span class="s3">!= </span><span class="s2">null </span><span class="s3">&amp;&amp; </span><span class="s1">name</span><span class="s3">.</span><span class="s1">isEmpty</span><span class="s3">()) {</span>
            <span class="s2">throw new </span><span class="s1">IllegalArgumentException</span><span class="s3">(</span><span class="s8">&quot;name must be non-empty or null&quot;</span><span class="s3">);</span>
        <span class="s3">}</span>

        <span class="s1">@SuppressWarnings</span><span class="s3">(</span><span class="s8">&quot;removal&quot;</span><span class="s3">)</span>
        <span class="s1">SecurityManager security </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">getSecurityManager</span><span class="s3">();</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">security </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">security</span><span class="s3">.</span><span class="s1">checkCreateClassLoader</span><span class="s3">();</span>
        <span class="s3">}</span>
        <span class="s2">return null</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">private </span><span class="s1">ClassLoader</span><span class="s3">(</span><span class="s1">Void unused</span><span class="s3">, </span><span class="s1">String name</span><span class="s3">, </span><span class="s1">ClassLoader parent</span><span class="s3">) {</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">name </span><span class="s3">= </span><span class="s1">name</span><span class="s3">;</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">parent </span><span class="s3">= </span><span class="s1">parent</span><span class="s3">;</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">unnamedModule </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Module</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">ParallelLoaders</span><span class="s3">.</span><span class="s1">isRegistered</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">getClass</span><span class="s3">())) {</span>
            <span class="s1">parallelLockMap </span><span class="s3">= </span><span class="s2">new </span><span class="s1">ConcurrentHashMap</span><span class="s3">&lt;&gt;();</span>
            <span class="s1">assertionLock </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Object</span><span class="s3">();</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s0">// no finer-grained lock; lock on the classloader instance</span>
            <span class="s1">parallelLockMap </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
            <span class="s1">assertionLock </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">package2certs </span><span class="s3">= </span><span class="s2">new </span><span class="s1">ConcurrentHashMap</span><span class="s3">&lt;&gt;();</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">nameAndId </span><span class="s3">= </span><span class="s1">nameAndId</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* If the defining loader has a name explicitly set then</span>
     <span class="s4">*       '</span><span class="s6">&lt;loader-name&gt;</span><span class="s4">' @</span><span class="s6">&lt;id&gt;</span>
     <span class="s4">* If the defining loader has no name then</span>
     <span class="s4">*       </span><span class="s6">&lt;qualified-class-name&gt; </span><span class="s4">@</span><span class="s6">&lt;id&gt;</span>
     <span class="s4">* If it's built-in loader then omit `@</span><span class="s6">&lt;id&gt;</span><span class="s4">` as there is only one instance.</span>
     <span class="s4">*/</span>
    <span class="s2">private static </span><span class="s1">String nameAndId</span><span class="s3">(</span><span class="s1">ClassLoader ld</span><span class="s3">) {</span>
        <span class="s1">String nid </span><span class="s3">= </span><span class="s1">ld</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">() != </span><span class="s2">null </span><span class="s3">? </span><span class="s8">&quot;</span><span class="s2">\'</span><span class="s8">&quot; </span><span class="s3">+ </span><span class="s1">ld</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">() + </span><span class="s8">&quot;</span><span class="s2">\'</span><span class="s8">&quot;</span>
                                          <span class="s3">: </span><span class="s1">ld</span><span class="s3">.</span><span class="s1">getClass</span><span class="s3">().</span><span class="s1">getName</span><span class="s3">();</span>
        <span class="s2">if </span><span class="s3">(!(</span><span class="s1">ld </span><span class="s2">instanceof </span><span class="s1">BuiltinClassLoader</span><span class="s3">)) {</span>
            <span class="s1">String id </span><span class="s3">= </span><span class="s1">Integer</span><span class="s3">.</span><span class="s1">toHexString</span><span class="s3">(</span><span class="s1">System</span><span class="s3">.</span><span class="s1">identityHashCode</span><span class="s3">(</span><span class="s1">ld</span><span class="s3">));</span>
            <span class="s1">nid </span><span class="s3">= </span><span class="s1">nid </span><span class="s3">+ </span><span class="s8">&quot; @&quot; </span><span class="s3">+ </span><span class="s1">id</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">nid</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// Returns nameAndId string for exception message printing</span>
    <span class="s1">String nameAndId</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">nameAndId</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Creates a new class loader of the specified name and using the</span>
     <span class="s4">* specified parent class loader for delegation.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">If the parent is specified as {</span><span class="s5">@code </span><span class="s4">null} (for the</span>
     <span class="s4">* bootstrap class loader) then there is no guarantee that all platform</span>
     <span class="s4">* classes are visible.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name   class loader name; or {</span><span class="s5">@code </span><span class="s4">null} if not named</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">parent the parent class loader</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">IllegalArgumentException if the given name is empty.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">SecurityException</span>
     <span class="s4">*         If a security manager exists and its</span>
     <span class="s4">*         {</span><span class="s5">@link </span><span class="s4">SecurityManager#checkCreateClassLoader()}</span>
     <span class="s4">*         method doesn't allow creation of a new class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">ClassLoader</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s1">ClassLoader parent</span><span class="s3">) {</span>
        <span class="s2">this</span><span class="s3">(</span><span class="s1">checkCreateClassLoader</span><span class="s3">(</span><span class="s1">name</span><span class="s3">), </span><span class="s1">name</span><span class="s3">, </span><span class="s1">parent</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Creates a new class loader using the specified parent class loader for</span>
     <span class="s4">* delegation.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">If there is a security manager, its {</span><span class="s5">@link</span>
     <span class="s4">* SecurityManager#checkCreateClassLoader() checkCreateClassLoader} method</span>
     <span class="s4">* is invoked.  This may result in a security exception.  </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">If the parent is specified as {</span><span class="s5">@code </span><span class="s4">null} (for the</span>
     <span class="s4">* bootstrap class loader) then there is no guarantee that all platform</span>
     <span class="s4">* classes are visible.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">parent</span>
     <span class="s4">*         The parent class loader</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">SecurityException</span>
     <span class="s4">*         If a security manager exists and its</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">checkCreateClassLoader} method doesn't allow creation</span>
     <span class="s4">*         of a new class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">ClassLoader</span><span class="s3">(</span><span class="s1">ClassLoader parent</span><span class="s3">) {</span>
        <span class="s2">this</span><span class="s3">(</span><span class="s1">checkCreateClassLoader</span><span class="s3">(), </span><span class="s2">null</span><span class="s3">, </span><span class="s1">parent</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Creates a new class loader using the {</span><span class="s5">@code </span><span class="s4">ClassLoader} returned by</span>
     <span class="s4">* the method {</span><span class="s5">@link </span><span class="s4">#getSystemClassLoader()</span>
     <span class="s4">* getSystemClassLoader()} as the parent class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">If there is a security manager, its {</span><span class="s5">@link</span>
     <span class="s4">* SecurityManager#checkCreateClassLoader()</span>
     <span class="s4">* checkCreateClassLoader} method is invoked.  This may result in</span>
     <span class="s4">* a security exception.  </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">SecurityException</span>
     <span class="s4">*          If a security manager exists and its</span>
     <span class="s4">*          {</span><span class="s5">@code </span><span class="s4">checkCreateClassLoader} method doesn't allow creation</span>
     <span class="s4">*          of a new class loader.</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">ClassLoader</span><span class="s3">() {</span>
        <span class="s2">this</span><span class="s3">(</span><span class="s1">checkCreateClassLoader</span><span class="s3">(), </span><span class="s2">null</span><span class="s3">, </span><span class="s1">getSystemClassLoader</span><span class="s3">());</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the name of this class loader or {</span><span class="s5">@code </span><span class="s4">null} if</span>
     <span class="s4">* this class loader is not named.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">This method is non-final for compatibility.  If this</span>
     <span class="s4">* method is overridden, this method must return the same name</span>
     <span class="s4">* as specified when this class loader was instantiated.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">name of this class loader; or {</span><span class="s5">@code </span><span class="s4">null} if</span>
     <span class="s4">* this class loader is not named.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public </span><span class="s1">String getName</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">name</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// package-private used by StackTraceElement to avoid</span>
    <span class="s0">// calling the overridable getName method</span>
    <span class="s2">final </span><span class="s1">String name</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">name</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// -- Class --</span>

    <span class="s4">/**</span>
     <span class="s4">* Loads the class with the specified </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt;</span><span class="s4">.</span>
     <span class="s4">* This method searches for classes in the same manner as the {</span><span class="s5">@link</span>
     <span class="s4">* #loadClass(String, boolean)} method.  It is invoked by the Java virtual</span>
     <span class="s4">* machine to resolve class references.  Invoking this method is equivalent</span>
     <span class="s4">* to invoking {</span><span class="s5">@link </span><span class="s4">#loadClass(String, boolean) loadClass(name,</span>
     <span class="s4">* false)}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param   </span><span class="s4">name</span>
     <span class="s4">*          The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The resulting {</span><span class="s5">@code </span><span class="s4">Class} object</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">ClassNotFoundException</span>
     <span class="s4">*          If the class was not found</span>
     <span class="s4">*/</span>
    <span class="s2">public </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">loadClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) </span><span class="s2">throws </span><span class="s1">ClassNotFoundException </span><span class="s3">{</span>
        <span class="s2">return </span><span class="s1">loadClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s2">false</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Loads the class with the specified </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt;</span><span class="s4">.  The</span>
     <span class="s4">* default implementation of this method searches for classes in the</span>
     <span class="s4">* following order:</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;ol&gt;</span>
     <span class="s4">*</span>
     <span class="s4">*   </span><span class="s6">&lt;li&gt;&lt;p&gt; </span><span class="s4">Invoke {</span><span class="s5">@link </span><span class="s4">#findLoadedClass(String)} to check if the class</span>
     <span class="s4">*   has already been loaded.  </span><span class="s6">&lt;/p&gt;&lt;/li&gt;</span>
     <span class="s4">*</span>
     <span class="s4">*   </span><span class="s6">&lt;li&gt;&lt;p&gt; </span><span class="s4">Invoke the {</span><span class="s5">@link </span><span class="s4">#loadClass(String) loadClass} method</span>
     <span class="s4">*   on the parent class loader.  If the parent is {</span><span class="s5">@code </span><span class="s4">null} the class</span>
     <span class="s4">*   loader built into the virtual machine is used, instead.  </span><span class="s6">&lt;/p&gt;&lt;/li&gt;</span>
     <span class="s4">*</span>
     <span class="s4">*   </span><span class="s6">&lt;li&gt;&lt;p&gt; </span><span class="s4">Invoke the {</span><span class="s5">@link </span><span class="s4">#findClass(String)} method to find the</span>
     <span class="s4">*   class.  </span><span class="s6">&lt;/p&gt;&lt;/li&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;/ol&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">If the class was found using the above steps, and the</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">resolve} flag is true, this method will then invoke the {</span><span class="s5">@link</span>
     <span class="s4">* #resolveClass(Class)} method on the resulting {</span><span class="s5">@code </span><span class="s4">Class} object.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Subclasses of {</span><span class="s5">@code </span><span class="s4">ClassLoader} are encouraged to override {</span><span class="s5">@link</span>
     <span class="s4">* #findClass(String)}, rather than this method.  </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Unless overridden, this method synchronizes on the result of</span>
     <span class="s4">* {</span><span class="s5">@link </span><span class="s4">#getClassLoadingLock getClassLoadingLock} method</span>
     <span class="s4">* during the entire class loading process.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param   </span><span class="s4">name</span>
     <span class="s4">*          The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param   </span><span class="s4">resolve</span>
     <span class="s4">*          If {</span><span class="s5">@code </span><span class="s4">true} then resolve the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The resulting {</span><span class="s5">@code </span><span class="s4">Class} object</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">ClassNotFoundException</span>
     <span class="s4">*          If the class could not be found</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">loadClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s2">boolean </span><span class="s1">resolve</span><span class="s3">)</span>
        <span class="s2">throws </span><span class="s1">ClassNotFoundException</span>
    <span class="s3">{</span>
        <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">getClassLoadingLock</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)) {</span>
            <span class="s0">// First, check if the class has already been loaded</span>
            <span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c </span><span class="s3">= </span><span class="s1">findLoadedClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">c </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
                <span class="s2">long </span><span class="s1">t0 </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">nanoTime</span><span class="s3">();</span>
                <span class="s2">try </span><span class="s3">{</span>
                    <span class="s2">if </span><span class="s3">(</span><span class="s1">parent </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
                        <span class="s1">c </span><span class="s3">= </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">loadClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s2">false</span><span class="s3">);</span>
                    <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
                        <span class="s1">c </span><span class="s3">= </span><span class="s1">findBootstrapClassOrNull</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
                    <span class="s3">}</span>
                <span class="s3">} </span><span class="s2">catch </span><span class="s3">(</span><span class="s1">ClassNotFoundException e</span><span class="s3">) {</span>
                    <span class="s0">// ClassNotFoundException thrown if class not found</span>
                    <span class="s0">// from the non-null parent class loader</span>
                <span class="s3">}</span>

                <span class="s2">if </span><span class="s3">(</span><span class="s1">c </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
                    <span class="s0">// If still not found, then invoke findClass in order</span>
                    <span class="s0">// to find the class.</span>
                    <span class="s2">long </span><span class="s1">t1 </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">nanoTime</span><span class="s3">();</span>
                    <span class="s1">c </span><span class="s3">= </span><span class="s1">findClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>

                    <span class="s0">// this is the defining class loader; record the stats</span>
                    <span class="s1">PerfCounter</span><span class="s3">.</span><span class="s1">getParentDelegationTime</span><span class="s3">().</span><span class="s1">addTime</span><span class="s3">(</span><span class="s1">t1 </span><span class="s3">- </span><span class="s1">t0</span><span class="s3">);</span>
                    <span class="s1">PerfCounter</span><span class="s3">.</span><span class="s1">getFindClassTime</span><span class="s3">().</span><span class="s1">addElapsedTimeFrom</span><span class="s3">(</span><span class="s1">t1</span><span class="s3">);</span>
                    <span class="s1">PerfCounter</span><span class="s3">.</span><span class="s1">getFindClasses</span><span class="s3">().</span><span class="s1">increment</span><span class="s3">();</span>
                <span class="s3">}</span>
            <span class="s3">}</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">resolve</span><span class="s3">) {</span>
                <span class="s1">resolveClass</span><span class="s3">(</span><span class="s1">c</span><span class="s3">);</span>
            <span class="s3">}</span>
            <span class="s2">return </span><span class="s1">c</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Loads the class with the specified </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt;</span>
     <span class="s4">* in a module defined to this class loader.  This method returns {</span><span class="s5">@code </span><span class="s4">null}</span>
     <span class="s4">* if the class could not be found.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">This method does not delegate to the parent class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation of this method searches for classes</span>
     <span class="s4">* in the following order:</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;ol&gt;</span>
     <span class="s4">*   </span><span class="s6">&lt;li&gt;</span><span class="s4">Invoke {</span><span class="s5">@link </span><span class="s4">#findLoadedClass(String)} to check if the class</span>
     <span class="s4">*   has already been loaded.</span><span class="s6">&lt;/li&gt;</span>
     <span class="s4">*   </span><span class="s6">&lt;li&gt;</span><span class="s4">Invoke the {</span><span class="s5">@link </span><span class="s4">#findClass(String, String)} method to find the</span>
     <span class="s4">*   class in the given module.</span><span class="s6">&lt;/li&gt;</span>
     <span class="s4">* </span><span class="s6">&lt;/ol&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">module</span>
     <span class="s4">*         The module</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">The resulting {</span><span class="s5">@code </span><span class="s4">Class} object in a module defined by</span>
     <span class="s4">*         this class loader, or {</span><span class="s5">@code </span><span class="s4">null} if the class could not be found.</span>
     <span class="s4">*/</span>
    <span class="s2">final </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">loadClass</span><span class="s3">(</span><span class="s1">Module module</span><span class="s3">, </span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">getClassLoadingLock</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)) {</span>
            <span class="s0">// First, check if the class has already been loaded</span>
            <span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c </span><span class="s3">= </span><span class="s1">findLoadedClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">c </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
                <span class="s1">c </span><span class="s3">= </span><span class="s1">findClass</span><span class="s3">(</span><span class="s1">module</span><span class="s3">.</span><span class="s1">getName</span><span class="s3">(), </span><span class="s1">name</span><span class="s3">);</span>
            <span class="s3">}</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">c </span><span class="s3">!= </span><span class="s2">null </span><span class="s3">&amp;&amp; </span><span class="s1">c</span><span class="s3">.</span><span class="s1">getModule</span><span class="s3">() == </span><span class="s1">module</span><span class="s3">) {</span>
                <span class="s2">return </span><span class="s1">c</span><span class="s3">;</span>
            <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
                <span class="s2">return null</span><span class="s3">;</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the lock object for class loading operations.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec</span>
     <span class="s4">* If this {</span><span class="s5">@code </span><span class="s4">ClassLoader} object is registered as parallel capable,</span>
     <span class="s4">* this method returns a dedicated object associated with the specified</span>
     <span class="s4">* class name. Otherwise, this method returns this {</span><span class="s5">@code </span><span class="s4">ClassLoader} object.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote</span>
     <span class="s4">* This method allows parallel capable class loaders to implement</span>
     <span class="s4">* finer-grained locking schemes such that multiple threads may load classes</span>
     <span class="s4">* concurrently without deadlocks.  For non-parallel-capable class loaders,</span>
     <span class="s4">* the {</span><span class="s5">@code </span><span class="s4">ClassLoader} object is synchronized on during the class loading</span>
     <span class="s4">* operations.  Class loaders with non-hierarchical delegation should be</span>
     <span class="s4">* {</span><span class="s5">@linkplain </span><span class="s4">#registerAsParallelCapable() registered as parallel capable}</span>
     <span class="s4">* to prevent deadlocks.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">className</span>
     <span class="s4">*         The name of the to-be-loaded class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">the lock for class loading operations</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">NullPointerException</span>
     <span class="s4">*         If registered as parallel capable and {</span><span class="s5">@code </span><span class="s4">className} is {</span><span class="s5">@code </span><span class="s4">null}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">#loadClass(String, boolean)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.7</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">Object getClassLoadingLock</span><span class="s3">(</span><span class="s1">String className</span><span class="s3">) {</span>
        <span class="s1">Object lock </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">parallelLockMap </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">Object newLock </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Object</span><span class="s3">();</span>
            <span class="s1">lock </span><span class="s3">= </span><span class="s1">parallelLockMap</span><span class="s3">.</span><span class="s1">putIfAbsent</span><span class="s3">(</span><span class="s1">className</span><span class="s3">, </span><span class="s1">newLock</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">lock </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
                <span class="s1">lock </span><span class="s3">= </span><span class="s1">newLock</span><span class="s3">;</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">lock</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// Invoked by the VM after loading class with this loader.</span>
    <span class="s1">@SuppressWarnings</span><span class="s3">(</span><span class="s8">&quot;removal&quot;</span><span class="s3">)</span>
    <span class="s2">private void </span><span class="s1">checkPackageAccess</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">cls</span><span class="s3">, </span><span class="s1">ProtectionDomain pd</span><span class="s3">) {</span>
        <span class="s2">final </span><span class="s1">SecurityManager sm </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">getSecurityManager</span><span class="s3">();</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">sm </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">ReflectUtil</span><span class="s3">.</span><span class="s1">isNonPublicProxyClass</span><span class="s3">(</span><span class="s1">cls</span><span class="s3">)) {</span>
                <span class="s2">for </span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">intf</span><span class="s3">: </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">getInterfaces</span><span class="s3">()) {</span>
                    <span class="s1">checkPackageAccess</span><span class="s3">(</span><span class="s1">intf</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">);</span>
                <span class="s3">}</span>
                <span class="s2">return</span><span class="s3">;</span>
            <span class="s3">}</span>

            <span class="s2">final </span><span class="s1">String packageName </span><span class="s3">= </span><span class="s1">cls</span><span class="s3">.</span><span class="s1">getPackageName</span><span class="s3">();</span>
            <span class="s2">if </span><span class="s3">(!</span><span class="s1">packageName</span><span class="s3">.</span><span class="s1">isEmpty</span><span class="s3">()) {</span>
                <span class="s1">AccessController</span><span class="s3">.</span><span class="s1">doPrivileged</span><span class="s3">(</span><span class="s2">new </span><span class="s1">PrivilegedAction</span><span class="s3">&lt;&gt;() {</span>
                    <span class="s2">public </span><span class="s1">Void run</span><span class="s3">() {</span>
                        <span class="s1">sm</span><span class="s3">.</span><span class="s1">checkPackageAccess</span><span class="s3">(</span><span class="s1">packageName</span><span class="s3">);</span>
                        <span class="s2">return null</span><span class="s3">;</span>
                    <span class="s3">}</span>
                <span class="s3">}, </span><span class="s2">new </span><span class="s1">AccessControlContext</span><span class="s3">(</span><span class="s2">new </span><span class="s1">ProtectionDomain</span><span class="s3">[] {</span><span class="s1">pd</span><span class="s3">}));</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Finds the class with the specified </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt;</span><span class="s4">.</span>
     <span class="s4">* This method should be overridden by class loader implementations that</span>
     <span class="s4">* follow the delegation model for loading classes, and will be invoked by</span>
     <span class="s4">* the {</span><span class="s5">@link </span><span class="s4">#loadClass loadClass} method after checking the</span>
     <span class="s4">* parent class loader for the requested class.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation throws {</span><span class="s5">@code </span><span class="s4">ClassNotFoundException}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param   </span><span class="s4">name</span>
     <span class="s4">*          The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The resulting {</span><span class="s5">@code </span><span class="s4">Class} object</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">ClassNotFoundException</span>
     <span class="s4">*          If the class could not be found</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">findClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) </span><span class="s2">throws </span><span class="s1">ClassNotFoundException </span><span class="s3">{</span>
        <span class="s2">throw new </span><span class="s1">ClassNotFoundException</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Finds the class with the given </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt;</span>
     <span class="s4">* in a module defined to this class loader.</span>
     <span class="s4">* Class loader implementations that support loading from modules</span>
     <span class="s4">* should override this method.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">This method returns {</span><span class="s5">@code </span><span class="s4">null} rather than throwing</span>
     <span class="s4">*          {</span><span class="s5">@code </span><span class="s4">ClassNotFoundException} if the class could not be found.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation attempts to find the class by</span>
     <span class="s4">* invoking {</span><span class="s5">@link </span><span class="s4">#findClass(String)} when the {</span><span class="s5">@code </span><span class="s4">moduleName} is</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">null}. It otherwise returns {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">moduleName</span>
     <span class="s4">*         The module name; or {</span><span class="s5">@code </span><span class="s4">null} to find the class in the</span>
     <span class="s4">*         {</span><span class="s5">@linkplain </span><span class="s4">#getUnnamedModule() unnamed module} for this</span>
     <span class="s4">*         class loader</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">The resulting {</span><span class="s5">@code </span><span class="s4">Class} object, or {</span><span class="s5">@code </span><span class="s4">null}</span>
     <span class="s4">*         if the class could not be found.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">findClass</span><span class="s3">(</span><span class="s1">String moduleName</span><span class="s3">, </span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">moduleName </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">try </span><span class="s3">{</span>
                <span class="s2">return </span><span class="s1">findClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
            <span class="s3">} </span><span class="s2">catch </span><span class="s3">(</span><span class="s1">ClassNotFoundException ignore</span><span class="s3">) { }</span>
        <span class="s3">}</span>
        <span class="s2">return null</span><span class="s3">;</span>
    <span class="s3">}</span>


    <span class="s4">/**</span>
     <span class="s4">* Converts an array of bytes into an instance of class {</span><span class="s5">@code </span><span class="s4">Class}.</span>
     <span class="s4">* Before the {</span><span class="s5">@code </span><span class="s4">Class} can be used it must be resolved.  This method</span>
     <span class="s4">* is deprecated in favor of the version that takes a </span><span class="s6">&lt;a</span>
     <span class="s4">* href=&quot;#binary-name&quot;&gt;binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">as its first argument, and is more secure.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">b</span>
     <span class="s4">*         The bytes that make up the class data.  The bytes in positions</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">off} through {</span><span class="s5">@code </span><span class="s4">off+len-1} should have the format</span>
     <span class="s4">*         of a valid class file as defined by</span>
     <span class="s4">*         </span><span class="s6">&lt;cite&gt;</span><span class="s4">The Java Virtual Machine Specification</span><span class="s6">&lt;/cite&gt;</span><span class="s4">.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">off</span>
     <span class="s4">*         The start offset in {</span><span class="s5">@code </span><span class="s4">b} of the class data</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">len</span>
     <span class="s4">*         The length of the class data</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">Class} object that was created from the specified</span>
     <span class="s4">*          class data</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">ClassFormatError</span>
     <span class="s4">*          If the data did not contain a valid class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">IndexOutOfBoundsException</span>
     <span class="s4">*          If either {</span><span class="s5">@code </span><span class="s4">off} or {</span><span class="s5">@code </span><span class="s4">len} is negative, or if</span>
     <span class="s4">*          {</span><span class="s5">@code </span><span class="s4">off+len} is greater than {</span><span class="s5">@code </span><span class="s4">b.length}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">SecurityException</span>
     <span class="s4">*          If an attempt is made to add this class to a package that</span>
     <span class="s4">*          contains classes that were signed by a different set of</span>
     <span class="s4">*          certificates than this class, or if an attempt is made</span>
     <span class="s4">*          to define a class in a package with a fully-qualified name</span>
     <span class="s4">*          that starts with &quot;{</span><span class="s5">@code </span><span class="s4">java.}&quot;.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#loadClass(String, boolean)</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#resolveClass(Class)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@deprecated  </span><span class="s4">Replaced by {</span><span class="s5">@link </span><span class="s4">#defineClass(String, byte[], int, int)</span>
     <span class="s4">* defineClass(String, byte[], int, int)}</span>
     <span class="s4">*/</span>
    <span class="s1">@Deprecated</span><span class="s3">(</span><span class="s1">since</span><span class="s3">=</span><span class="s8">&quot;1.1&quot;</span><span class="s3">)</span>
    <span class="s2">protected final </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">defineClass</span><span class="s3">(</span><span class="s2">byte</span><span class="s3">[] </span><span class="s1">b</span><span class="s3">, </span><span class="s2">int </span><span class="s1">off</span><span class="s3">, </span><span class="s2">int </span><span class="s1">len</span><span class="s3">)</span>
        <span class="s2">throws </span><span class="s1">ClassFormatError</span>
    <span class="s3">{</span>
        <span class="s2">return </span><span class="s1">defineClass</span><span class="s3">(</span><span class="s2">null</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">off</span><span class="s3">, </span><span class="s1">len</span><span class="s3">, </span><span class="s2">null</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Converts an array of bytes into an instance of class {</span><span class="s5">@code </span><span class="s4">Class}.</span>
     <span class="s4">* Before the {</span><span class="s5">@code </span><span class="s4">Class} can be used it must be resolved.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">This method assigns a default {</span><span class="s5">@link </span><span class="s4">java.security.ProtectionDomain</span>
     <span class="s4">* ProtectionDomain} to the newly defined class.  The</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">ProtectionDomain} is effectively granted the same set of</span>
     <span class="s4">* permissions returned when {</span><span class="s5">@link</span>
     <span class="s4">* java.security.Policy#getPermissions(java.security.CodeSource)</span>
     <span class="s4">* Policy.getPolicy().getPermissions(new CodeSource(null, null))}</span>
     <span class="s4">* is invoked.  The default protection domain is created on the first invocation</span>
     <span class="s4">* of {</span><span class="s5">@link </span><span class="s4">#defineClass(String, byte[], int, int) defineClass},</span>
     <span class="s4">* and re-used on subsequent invocations.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">To assign a specific {</span><span class="s5">@code </span><span class="s4">ProtectionDomain} to the class, use</span>
     <span class="s4">* the {</span><span class="s5">@link </span><span class="s4">#defineClass(String, byte[], int, int,</span>
     <span class="s4">* java.security.ProtectionDomain) defineClass} method that takes a</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">ProtectionDomain} as one of its arguments.  </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt;</span>
     <span class="s4">* This method defines a package in this class loader corresponding to the</span>
     <span class="s4">* package of the {</span><span class="s5">@code </span><span class="s4">Class} (if such a package has not already been defined</span>
     <span class="s4">* in this class loader). The name of the defined package is derived from</span>
     <span class="s4">* the </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class specified by</span>
     <span class="s4">* the byte array {</span><span class="s5">@code </span><span class="s4">b}.</span>
     <span class="s4">* Other properties of the defined package are as specified by {</span><span class="s5">@link </span><span class="s4">Package}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The expected </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class, or</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">null} if not known</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">b</span>
     <span class="s4">*         The bytes that make up the class data.  The bytes in positions</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">off} through {</span><span class="s5">@code </span><span class="s4">off+len-1} should have the format</span>
     <span class="s4">*         of a valid class file as defined by</span>
     <span class="s4">*         </span><span class="s6">&lt;cite&gt;</span><span class="s4">The Java Virtual Machine Specification</span><span class="s6">&lt;/cite&gt;</span><span class="s4">.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">off</span>
     <span class="s4">*         The start offset in {</span><span class="s5">@code </span><span class="s4">b} of the class data</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">len</span>
     <span class="s4">*         The length of the class data</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">Class} object that was created from the specified</span>
     <span class="s4">*          class data.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">ClassFormatError</span>
     <span class="s4">*          If the data did not contain a valid class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">IndexOutOfBoundsException</span>
     <span class="s4">*          If either {</span><span class="s5">@code </span><span class="s4">off} or {</span><span class="s5">@code </span><span class="s4">len} is negative, or if</span>
     <span class="s4">*          {</span><span class="s5">@code </span><span class="s4">off+len} is greater than {</span><span class="s5">@code </span><span class="s4">b.length}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">SecurityException</span>
     <span class="s4">*          If an attempt is made to add this class to a package that</span>
     <span class="s4">*          contains classes that were signed by a different set of</span>
     <span class="s4">*          certificates than this class (which is unsigned), or if</span>
     <span class="s4">*          {</span><span class="s5">@code </span><span class="s4">name} begins with &quot;{</span><span class="s5">@code </span><span class="s4">java.}&quot;.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#loadClass(String, boolean)</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#resolveClass(Class)</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">java.security.CodeSource</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">java.security.SecureClassLoader</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.1</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected final </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">defineClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s2">byte</span><span class="s3">[] </span><span class="s1">b</span><span class="s3">, </span><span class="s2">int </span><span class="s1">off</span><span class="s3">, </span><span class="s2">int </span><span class="s1">len</span><span class="s3">)</span>
        <span class="s2">throws </span><span class="s1">ClassFormatError</span>
    <span class="s3">{</span>
        <span class="s2">return </span><span class="s1">defineClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">off</span><span class="s3">, </span><span class="s1">len</span><span class="s3">, </span><span class="s2">null</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s0">/* Determine protection domain, and check that: 
        - not define java.* class, 
        - signer of this class matches signers for the rest of the classes in 
          package. 
    */</span>
    <span class="s2">private </span><span class="s1">ProtectionDomain preDefineClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">,</span>
                                            <span class="s1">ProtectionDomain pd</span><span class="s3">)</span>
    <span class="s3">{</span>
        <span class="s2">if </span><span class="s3">(!</span><span class="s1">checkName</span><span class="s3">(</span><span class="s1">name</span><span class="s3">))</span>
            <span class="s2">throw new </span><span class="s1">NoClassDefFoundError</span><span class="s3">(</span><span class="s8">&quot;IllegalName: &quot; </span><span class="s3">+ </span><span class="s1">name</span><span class="s3">);</span>

        <span class="s0">// Note:  Checking logic in java.lang.invoke.MemberName.checkForTypeAlias</span>
        <span class="s0">// relies on the fact that spoofing is impossible if a class has a name</span>
        <span class="s0">// of the form &quot;java.*&quot;</span>
        <span class="s2">if </span><span class="s3">((</span><span class="s1">name </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) &amp;&amp; </span><span class="s1">name</span><span class="s3">.</span><span class="s1">startsWith</span><span class="s3">(</span><span class="s8">&quot;java.&quot;</span><span class="s3">)</span>
                <span class="s3">&amp;&amp; </span><span class="s2">this </span><span class="s3">!= </span><span class="s1">getBuiltinPlatformClassLoader</span><span class="s3">()) {</span>
            <span class="s2">throw new </span><span class="s1">SecurityException</span>
                <span class="s3">(</span><span class="s8">&quot;Prohibited package name: &quot; </span><span class="s3">+</span>
                 <span class="s1">name</span><span class="s3">.</span><span class="s1">substring</span><span class="s3">(</span><span class="s7">0</span><span class="s3">, </span><span class="s1">name</span><span class="s3">.</span><span class="s1">lastIndexOf</span><span class="s3">(</span><span class="s8">'.'</span><span class="s3">)));</span>
        <span class="s3">}</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">pd </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">pd </span><span class="s3">= </span><span class="s1">defaultDomain</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">name </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">checkCerts</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">getCodeSource</span><span class="s3">());</span>
        <span class="s3">}</span>

        <span class="s2">return </span><span class="s1">pd</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">private </span><span class="s1">String defineClassSourceLocation</span><span class="s3">(</span><span class="s1">ProtectionDomain pd</span><span class="s3">) {</span>
        <span class="s1">CodeSource cs </span><span class="s3">= </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">getCodeSource</span><span class="s3">();</span>
        <span class="s1">String source </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">cs </span><span class="s3">!= </span><span class="s2">null </span><span class="s3">&amp;&amp; </span><span class="s1">cs</span><span class="s3">.</span><span class="s1">getLocation</span><span class="s3">() != </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">source </span><span class="s3">= </span><span class="s1">cs</span><span class="s3">.</span><span class="s1">getLocation</span><span class="s3">().</span><span class="s1">toString</span><span class="s3">();</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">source</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">private void </span><span class="s1">postDefineClass</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c</span><span class="s3">, </span><span class="s1">ProtectionDomain pd</span><span class="s3">) {</span>
        <span class="s0">// define a named package, if not present</span>
        <span class="s1">getNamedPackage</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">getPackageName</span><span class="s3">(), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">getModule</span><span class="s3">());</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">pd</span><span class="s3">.</span><span class="s1">getCodeSource</span><span class="s3">() != </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">Certificate certs</span><span class="s3">[] = </span><span class="s1">pd</span><span class="s3">.</span><span class="s1">getCodeSource</span><span class="s3">().</span><span class="s1">getCertificates</span><span class="s3">();</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">certs </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">)</span>
                <span class="s1">setSigners</span><span class="s3">(</span><span class="s1">c</span><span class="s3">, </span><span class="s1">certs</span><span class="s3">);</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Converts an array of bytes into an instance of class {</span><span class="s5">@code </span><span class="s4">Class},</span>
     <span class="s4">* with a given {</span><span class="s5">@code </span><span class="s4">ProtectionDomain}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">If the given {</span><span class="s5">@code </span><span class="s4">ProtectionDomain} is {</span><span class="s5">@code </span><span class="s4">null},</span>
     <span class="s4">* then a default protection domain will be assigned to the class as specified</span>
     <span class="s4">* in the documentation for {</span><span class="s5">@link </span><span class="s4">#defineClass(String, byte[], int, int)}.</span>
     <span class="s4">* Before the class can be used it must be resolved.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The first class defined in a package determines the exact set of</span>
     <span class="s4">* certificates that all subsequent classes defined in that package must</span>
     <span class="s4">* contain.  The set of certificates for a class is obtained from the</span>
     <span class="s4">* {</span><span class="s5">@link </span><span class="s4">java.security.CodeSource CodeSource} within the</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">ProtectionDomain} of the class.  Any classes added to that</span>
     <span class="s4">* package must contain the same set of certificates or a</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">SecurityException} will be thrown.  Note that if</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">name} is {</span><span class="s5">@code </span><span class="s4">null}, this check is not performed.</span>
     <span class="s4">* You should always pass in the </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the</span>
     <span class="s4">* class you are defining as well as the bytes.  This ensures that the</span>
     <span class="s4">* class you are defining is indeed the class you think it is.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">If the specified {</span><span class="s5">@code </span><span class="s4">name} begins with &quot;{</span><span class="s5">@code </span><span class="s4">java.}&quot;, it can</span>
     <span class="s4">* only be defined by the {</span><span class="s5">@linkplain </span><span class="s4">#getPlatformClassLoader()</span>
     <span class="s4">* platform class loader} or its ancestors; otherwise {</span><span class="s5">@code </span><span class="s4">SecurityException}</span>
     <span class="s4">* will be thrown.  If {</span><span class="s5">@code </span><span class="s4">name} is not {</span><span class="s5">@code </span><span class="s4">null}, it must be equal to</span>
     <span class="s4">* the </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class</span>
     <span class="s4">* specified by the byte array {</span><span class="s5">@code </span><span class="s4">b}, otherwise a {</span><span class="s5">@link</span>
     <span class="s4">* NoClassDefFoundError NoClassDefFoundError} will be thrown.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">This method defines a package in this class loader corresponding to the</span>
     <span class="s4">* package of the {</span><span class="s5">@code </span><span class="s4">Class} (if such a package has not already been defined</span>
     <span class="s4">* in this class loader). The name of the defined package is derived from</span>
     <span class="s4">* the </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class specified by</span>
     <span class="s4">* the byte array {</span><span class="s5">@code </span><span class="s4">b}.</span>
     <span class="s4">* Other properties of the defined package are as specified by {</span><span class="s5">@link </span><span class="s4">Package}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The expected </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class, or</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">null} if not known</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">b</span>
     <span class="s4">*         The bytes that make up the class data. The bytes in positions</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">off} through {</span><span class="s5">@code </span><span class="s4">off+len-1} should have the format</span>
     <span class="s4">*         of a valid class file as defined by</span>
     <span class="s4">*         </span><span class="s6">&lt;cite&gt;</span><span class="s4">The Java Virtual Machine Specification</span><span class="s6">&lt;/cite&gt;</span><span class="s4">.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">off</span>
     <span class="s4">*         The start offset in {</span><span class="s5">@code </span><span class="s4">b} of the class data</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">len</span>
     <span class="s4">*         The length of the class data</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">protectionDomain</span>
     <span class="s4">*         The {</span><span class="s5">@code </span><span class="s4">ProtectionDomain} of the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">Class} object created from the data,</span>
     <span class="s4">*          and {</span><span class="s5">@code </span><span class="s4">ProtectionDomain}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">ClassFormatError</span>
     <span class="s4">*          If the data did not contain a valid class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NoClassDefFoundError</span>
     <span class="s4">*          If {</span><span class="s5">@code </span><span class="s4">name} is not {</span><span class="s5">@code </span><span class="s4">null} and not equal to the</span>
     <span class="s4">*          </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class specified by {</span><span class="s5">@code </span><span class="s4">b}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">IndexOutOfBoundsException</span>
     <span class="s4">*          If either {</span><span class="s5">@code </span><span class="s4">off} or {</span><span class="s5">@code </span><span class="s4">len} is negative, or if</span>
     <span class="s4">*          {</span><span class="s5">@code </span><span class="s4">off+len} is greater than {</span><span class="s5">@code </span><span class="s4">b.length}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">SecurityException</span>
     <span class="s4">*          If an attempt is made to add this class to a package that</span>
     <span class="s4">*          contains classes that were signed by a different set of</span>
     <span class="s4">*          certificates than this class, or if {</span><span class="s5">@code </span><span class="s4">name} begins with</span>
     <span class="s4">*          &quot;{</span><span class="s5">@code </span><span class="s4">java.}&quot; and this class loader is not the platform</span>
     <span class="s4">*          class loader or its ancestor.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected final </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">defineClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s2">byte</span><span class="s3">[] </span><span class="s1">b</span><span class="s3">, </span><span class="s2">int </span><span class="s1">off</span><span class="s3">, </span><span class="s2">int </span><span class="s1">len</span><span class="s3">,</span>
                                         <span class="s1">ProtectionDomain protectionDomain</span><span class="s3">)</span>
        <span class="s2">throws </span><span class="s1">ClassFormatError</span>
    <span class="s3">{</span>
        <span class="s1">protectionDomain </span><span class="s3">= </span><span class="s1">preDefineClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">protectionDomain</span><span class="s3">);</span>
        <span class="s1">String source </span><span class="s3">= </span><span class="s1">defineClassSourceLocation</span><span class="s3">(</span><span class="s1">protectionDomain</span><span class="s3">);</span>
        <span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c </span><span class="s3">= </span><span class="s1">defineClass1</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">off</span><span class="s3">, </span><span class="s1">len</span><span class="s3">, </span><span class="s1">protectionDomain</span><span class="s3">, </span><span class="s1">source</span><span class="s3">);</span>
        <span class="s1">postDefineClass</span><span class="s3">(</span><span class="s1">c</span><span class="s3">, </span><span class="s1">protectionDomain</span><span class="s3">);</span>
        <span class="s2">return </span><span class="s1">c</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Converts a {</span><span class="s5">@link </span><span class="s4">java.nio.ByteBuffer ByteBuffer} into an instance</span>
     <span class="s4">* of class {</span><span class="s5">@code </span><span class="s4">Class}, with the given {</span><span class="s5">@code </span><span class="s4">ProtectionDomain}.</span>
     <span class="s4">* If the given {</span><span class="s5">@code </span><span class="s4">ProtectionDomain} is {</span><span class="s5">@code </span><span class="s4">null}, then a default</span>
     <span class="s4">* protection domain will be assigned to the class as</span>
     <span class="s4">* specified in the documentation for {</span><span class="s5">@link </span><span class="s4">#defineClass(String, byte[],</span>
     <span class="s4">* int, int)}.  Before the class can be used it must be resolved.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt;</span><span class="s4">The rules about the first class defined in a package determining the</span>
     <span class="s4">* set of certificates for the package, the restrictions on class names,</span>
     <span class="s4">* and the defined package of the class</span>
     <span class="s4">* are identical to those specified in the documentation for {</span><span class="s5">@link</span>
     <span class="s4">* #defineClass(String, byte[], int, int, ProtectionDomain)}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">An invocation of this method of the form</span>
     <span class="s4">* </span><span class="s6">&lt;i&gt;</span><span class="s4">cl</span><span class="s6">&lt;/i&gt;</span><span class="s4">{</span><span class="s5">@code </span><span class="s4">.defineClass(}</span><span class="s6">&lt;i&gt;</span><span class="s4">name</span><span class="s6">&lt;/i&gt;</span><span class="s4">{</span><span class="s5">@code </span><span class="s4">,}</span>
     <span class="s4">* </span><span class="s6">&lt;i&gt;</span><span class="s4">bBuffer</span><span class="s6">&lt;/i&gt;</span><span class="s4">{</span><span class="s5">@code </span><span class="s4">,} </span><span class="s6">&lt;i&gt;</span><span class="s4">pd</span><span class="s6">&lt;/i&gt;</span><span class="s4">{</span><span class="s5">@code </span><span class="s4">)} yields exactly the same</span>
     <span class="s4">* result as the statements</span>
     <span class="s4">*</span>
     <span class="s4">*</span><span class="s6">&lt;p&gt; &lt;code&gt;</span>
     <span class="s4">* ...</span><span class="s6">&lt;br&gt;</span>
     <span class="s4">* byte[] temp = new byte[bBuffer.{</span><span class="s5">@link</span>
     <span class="s4">* java.nio.ByteBuffer#remaining remaining}()];</span><span class="s6">&lt;br&gt;</span>
     <span class="s4">*     bBuffer.{</span><span class="s5">@link </span><span class="s4">java.nio.ByteBuffer#get(byte[])</span>
     <span class="s4">* get}(temp);</span><span class="s6">&lt;br&gt;</span>
     <span class="s4">*     return {</span><span class="s5">@link </span><span class="s4">#defineClass(String, byte[], int, int, ProtectionDomain)</span>
     <span class="s4">* cl.defineClass}(name, temp, 0,</span>
     <span class="s4">* temp.length, pd);</span><span class="s6">&lt;br&gt;</span>
     <span class="s4">* </span><span class="s6">&lt;/code&gt;&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The expected </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt;</span><span class="s4">. of the class, or</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">null} if not known</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">b</span>
     <span class="s4">*         The bytes that make up the class data. The bytes from positions</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">b.position()} through {</span><span class="s5">@code </span><span class="s4">b.position() + b.limit() -1</span>
     <span class="s4">*         } should have the format of a valid class file as defined by</span>
     <span class="s4">*         </span><span class="s6">&lt;cite&gt;</span><span class="s4">The Java Virtual Machine Specification</span><span class="s6">&lt;/cite&gt;</span><span class="s4">.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">protectionDomain</span>
     <span class="s4">*         The {</span><span class="s5">@code </span><span class="s4">ProtectionDomain} of the class, or {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">Class} object created from the data,</span>
     <span class="s4">*          and {</span><span class="s5">@code </span><span class="s4">ProtectionDomain}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">ClassFormatError</span>
     <span class="s4">*          If the data did not contain a valid class.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NoClassDefFoundError</span>
     <span class="s4">*          If {</span><span class="s5">@code </span><span class="s4">name} is not {</span><span class="s5">@code </span><span class="s4">null} and not equal to the</span>
     <span class="s4">*          </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class specified by {</span><span class="s5">@code </span><span class="s4">b}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">SecurityException</span>
     <span class="s4">*          If an attempt is made to add this class to a package that</span>
     <span class="s4">*          contains classes that were signed by a different set of</span>
     <span class="s4">*          certificates than this class, or if {</span><span class="s5">@code </span><span class="s4">name} begins with</span>
     <span class="s4">*          &quot;{</span><span class="s5">@code </span><span class="s4">java.}&quot;.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see      </span><span class="s4">#defineClass(String, byte[], int, int, ProtectionDomain)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.5</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected final </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">defineClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s1">java</span><span class="s3">.</span><span class="s1">nio</span><span class="s3">.</span><span class="s1">ByteBuffer b</span><span class="s3">,</span>
                                         <span class="s1">ProtectionDomain protectionDomain</span><span class="s3">)</span>
        <span class="s2">throws </span><span class="s1">ClassFormatError</span>
    <span class="s3">{</span>
        <span class="s2">int </span><span class="s1">len </span><span class="s3">= </span><span class="s1">b</span><span class="s3">.</span><span class="s1">remaining</span><span class="s3">();</span>

        <span class="s0">// Use byte[] if not a direct ByteBuffer:</span>
        <span class="s2">if </span><span class="s3">(!</span><span class="s1">b</span><span class="s3">.</span><span class="s1">isDirect</span><span class="s3">()) {</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">b</span><span class="s3">.</span><span class="s1">hasArray</span><span class="s3">()) {</span>
                <span class="s2">return </span><span class="s1">defineClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">b</span><span class="s3">.</span><span class="s1">array</span><span class="s3">(),</span>
                                   <span class="s1">b</span><span class="s3">.</span><span class="s1">position</span><span class="s3">() + </span><span class="s1">b</span><span class="s3">.</span><span class="s1">arrayOffset</span><span class="s3">(), </span><span class="s1">len</span><span class="s3">,</span>
                                   <span class="s1">protectionDomain</span><span class="s3">);</span>
            <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
                <span class="s0">// no array, or read-only array</span>
                <span class="s2">byte</span><span class="s3">[] </span><span class="s1">tb </span><span class="s3">= </span><span class="s2">new byte</span><span class="s3">[</span><span class="s1">len</span><span class="s3">];</span>
                <span class="s1">b</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">tb</span><span class="s3">);  </span><span class="s0">// get bytes out of byte buffer.</span>
                <span class="s2">return </span><span class="s1">defineClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">tb</span><span class="s3">, </span><span class="s7">0</span><span class="s3">, </span><span class="s1">len</span><span class="s3">, </span><span class="s1">protectionDomain</span><span class="s3">);</span>
            <span class="s3">}</span>
        <span class="s3">}</span>

        <span class="s1">protectionDomain </span><span class="s3">= </span><span class="s1">preDefineClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">protectionDomain</span><span class="s3">);</span>
        <span class="s1">String source </span><span class="s3">= </span><span class="s1">defineClassSourceLocation</span><span class="s3">(</span><span class="s1">protectionDomain</span><span class="s3">);</span>
        <span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c </span><span class="s3">= </span><span class="s1">defineClass2</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s1">name</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">b</span><span class="s3">.</span><span class="s1">position</span><span class="s3">(), </span><span class="s1">len</span><span class="s3">, </span><span class="s1">protectionDomain</span><span class="s3">, </span><span class="s1">source</span><span class="s3">);</span>
        <span class="s1">postDefineClass</span><span class="s3">(</span><span class="s1">c</span><span class="s3">, </span><span class="s1">protectionDomain</span><span class="s3">);</span>
        <span class="s2">return </span><span class="s1">c</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">static native </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">defineClass1</span><span class="s3">(</span><span class="s1">ClassLoader loader</span><span class="s3">, </span><span class="s1">String name</span><span class="s3">, </span><span class="s2">byte</span><span class="s3">[] </span><span class="s1">b</span><span class="s3">, </span><span class="s2">int </span><span class="s1">off</span><span class="s3">, </span><span class="s2">int </span><span class="s1">len</span><span class="s3">,</span>
                                        <span class="s1">ProtectionDomain pd</span><span class="s3">, </span><span class="s1">String source</span><span class="s3">);</span>

    <span class="s2">static native </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">defineClass2</span><span class="s3">(</span><span class="s1">ClassLoader loader</span><span class="s3">, </span><span class="s1">String name</span><span class="s3">, </span><span class="s1">java</span><span class="s3">.</span><span class="s1">nio</span><span class="s3">.</span><span class="s1">ByteBuffer b</span><span class="s3">,</span>
                                        <span class="s2">int </span><span class="s1">off</span><span class="s3">, </span><span class="s2">int </span><span class="s1">len</span><span class="s3">, </span><span class="s1">ProtectionDomain pd</span><span class="s3">,</span>
                                        <span class="s1">String source</span><span class="s3">);</span>

    <span class="s4">/**</span>
     <span class="s4">* Defines a class of the given flags via Lookup.defineClass.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">loader the defining loader</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">lookup nest host of the Class to be defined</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">name the binary name or {</span><span class="s5">@code </span><span class="s4">null} if not findable</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">b class bytes</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">off the start offset in {</span><span class="s5">@code </span><span class="s4">b} of the class bytes</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">len the length of the class bytes</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">pd protection domain</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">initialize initialize the class</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">flags flags</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">classData class data</span>
     <span class="s4">*/</span>
    <span class="s2">static native </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">defineClass0</span><span class="s3">(</span><span class="s1">ClassLoader loader</span><span class="s3">,</span>
                                        <span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">lookup</span><span class="s3">,</span>
                                        <span class="s1">String name</span><span class="s3">,</span>
                                        <span class="s2">byte</span><span class="s3">[] </span><span class="s1">b</span><span class="s3">, </span><span class="s2">int </span><span class="s1">off</span><span class="s3">, </span><span class="s2">int </span><span class="s1">len</span><span class="s3">,</span>
                                        <span class="s1">ProtectionDomain pd</span><span class="s3">,</span>
                                        <span class="s2">boolean </span><span class="s1">initialize</span><span class="s3">,</span>
                                        <span class="s2">int </span><span class="s1">flags</span><span class="s3">,</span>
                                        <span class="s1">Object classData</span><span class="s3">);</span>

    <span class="s0">// true if the name is null or has the potential to be a valid binary name</span>
    <span class="s2">private static boolean </span><span class="s1">checkName</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">((</span><span class="s1">name </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) || (</span><span class="s1">name</span><span class="s3">.</span><span class="s1">isEmpty</span><span class="s3">()))</span>
            <span class="s2">return true</span><span class="s3">;</span>
        <span class="s2">if </span><span class="s3">((</span><span class="s1">name</span><span class="s3">.</span><span class="s1">indexOf</span><span class="s3">(</span><span class="s8">'/'</span><span class="s3">) != -</span><span class="s7">1</span><span class="s3">) || (</span><span class="s1">name</span><span class="s3">.</span><span class="s1">charAt</span><span class="s3">(</span><span class="s7">0</span><span class="s3">) == </span><span class="s8">'['</span><span class="s3">))</span>
            <span class="s2">return false</span><span class="s3">;</span>
        <span class="s2">return true</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">private void </span><span class="s1">checkCerts</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s1">CodeSource cs</span><span class="s3">) {</span>
        <span class="s2">int </span><span class="s1">i </span><span class="s3">= </span><span class="s1">name</span><span class="s3">.</span><span class="s1">lastIndexOf</span><span class="s3">(</span><span class="s8">'.'</span><span class="s3">);</span>
        <span class="s1">String pname </span><span class="s3">= (</span><span class="s1">i </span><span class="s3">== -</span><span class="s7">1</span><span class="s3">) ? </span><span class="s8">&quot;&quot; </span><span class="s3">: </span><span class="s1">name</span><span class="s3">.</span><span class="s1">substring</span><span class="s3">(</span><span class="s7">0</span><span class="s3">, </span><span class="s1">i</span><span class="s3">);</span>

        <span class="s1">Certificate</span><span class="s3">[] </span><span class="s1">certs </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">cs </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">certs </span><span class="s3">= </span><span class="s1">cs</span><span class="s3">.</span><span class="s1">getCertificates</span><span class="s3">();</span>
        <span class="s3">}</span>
        <span class="s1">certs </span><span class="s3">= </span><span class="s1">certs </span><span class="s3">== </span><span class="s2">null </span><span class="s3">? </span><span class="s1">nocerts </span><span class="s3">: </span><span class="s1">certs</span><span class="s3">;</span>
        <span class="s1">Certificate</span><span class="s3">[] </span><span class="s1">pcerts </span><span class="s3">= </span><span class="s1">package2certs</span><span class="s3">.</span><span class="s1">putIfAbsent</span><span class="s3">(</span><span class="s1">pname</span><span class="s3">, </span><span class="s1">certs</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">pcerts </span><span class="s3">!= </span><span class="s2">null </span><span class="s3">&amp;&amp; !</span><span class="s1">compareCerts</span><span class="s3">(</span><span class="s1">pcerts</span><span class="s3">, </span><span class="s1">certs</span><span class="s3">)) {</span>
            <span class="s2">throw new </span><span class="s1">SecurityException</span><span class="s3">(</span><span class="s8">&quot;class </span><span class="s2">\&quot;</span><span class="s8">&quot; </span><span class="s3">+ </span><span class="s1">name</span>
                <span class="s3">+ </span><span class="s8">&quot;</span><span class="s2">\&quot;</span><span class="s8">'s signer information does not match signer information&quot;</span>
                <span class="s3">+ </span><span class="s8">&quot; of other classes in the same package&quot;</span><span class="s3">);</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* check to make sure the certs for the new class (certs) are the same as</span>
     <span class="s4">* the certs for the first class inserted in the package (pcerts)</span>
     <span class="s4">*/</span>
    <span class="s2">private boolean </span><span class="s1">compareCerts</span><span class="s3">(</span><span class="s1">Certificate</span><span class="s3">[] </span><span class="s1">pcerts</span><span class="s3">, </span><span class="s1">Certificate</span><span class="s3">[] </span><span class="s1">certs</span><span class="s3">) {</span>
        <span class="s0">// empty array fast-path</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">certs</span><span class="s3">.</span><span class="s1">length </span><span class="s3">== </span><span class="s7">0</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">pcerts</span><span class="s3">.</span><span class="s1">length </span><span class="s3">== </span><span class="s7">0</span><span class="s3">;</span>

        <span class="s0">// the length must be the same at this point</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">certs</span><span class="s3">.</span><span class="s1">length </span><span class="s3">!= </span><span class="s1">pcerts</span><span class="s3">.</span><span class="s1">length</span><span class="s3">)</span>
            <span class="s2">return false</span><span class="s3">;</span>

        <span class="s0">// go through and make sure all the certs in one array</span>
        <span class="s0">// are in the other and vice-versa.</span>
        <span class="s2">boolean </span><span class="s1">match</span><span class="s3">;</span>
        <span class="s2">for </span><span class="s3">(</span><span class="s1">Certificate cert </span><span class="s3">: </span><span class="s1">certs</span><span class="s3">) {</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s2">false</span><span class="s3">;</span>
            <span class="s2">for </span><span class="s3">(</span><span class="s1">Certificate pcert </span><span class="s3">: </span><span class="s1">pcerts</span><span class="s3">) {</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">cert</span><span class="s3">.</span><span class="s1">equals</span><span class="s3">(</span><span class="s1">pcert</span><span class="s3">)) {</span>
                    <span class="s1">match </span><span class="s3">= </span><span class="s2">true</span><span class="s3">;</span>
                    <span class="s2">break</span><span class="s3">;</span>
                <span class="s3">}</span>
            <span class="s3">}</span>
            <span class="s2">if </span><span class="s3">(!</span><span class="s1">match</span><span class="s3">) </span><span class="s2">return false</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s0">// now do the same for pcerts</span>
        <span class="s2">for </span><span class="s3">(</span><span class="s1">Certificate pcert </span><span class="s3">: </span><span class="s1">pcerts</span><span class="s3">) {</span>
            <span class="s1">match </span><span class="s3">= </span><span class="s2">false</span><span class="s3">;</span>
            <span class="s2">for </span><span class="s3">(</span><span class="s1">Certificate cert </span><span class="s3">: </span><span class="s1">certs</span><span class="s3">) {</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">pcert</span><span class="s3">.</span><span class="s1">equals</span><span class="s3">(</span><span class="s1">cert</span><span class="s3">)) {</span>
                    <span class="s1">match </span><span class="s3">= </span><span class="s2">true</span><span class="s3">;</span>
                    <span class="s2">break</span><span class="s3">;</span>
                <span class="s3">}</span>
            <span class="s3">}</span>
            <span class="s2">if </span><span class="s3">(!</span><span class="s1">match</span><span class="s3">) </span><span class="s2">return false</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s2">return true</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Links the specified class.  This (misleadingly named) method may be</span>
     <span class="s4">* used by a class loader to link a class.  If the class {</span><span class="s5">@code </span><span class="s4">c} has</span>
     <span class="s4">* already been linked, then this method simply returns. Otherwise, the</span>
     <span class="s4">* class is linked as described in the &quot;Execution&quot; chapter of</span>
     <span class="s4">* </span><span class="s6">&lt;cite&gt;</span><span class="s4">The Java Language Specification</span><span class="s6">&lt;/cite&gt;</span><span class="s4">.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">c</span>
     <span class="s4">*         The class to link</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NullPointerException</span>
     <span class="s4">*          If {</span><span class="s5">@code </span><span class="s4">c} is {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#defineClass(String, byte[], int, int)</span>
     <span class="s4">*/</span>
    <span class="s2">protected final void </span><span class="s1">resolveClass</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">c </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">throw new </span><span class="s1">NullPointerException</span><span class="s3">();</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Finds a class with the specified </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt;</span><span class="s4">,</span>
     <span class="s4">* loading it if necessary.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">This method loads the class through the system class loader (see</span>
     <span class="s4">* {</span><span class="s5">@link </span><span class="s4">#getSystemClassLoader()}).  The {</span><span class="s5">@code </span><span class="s4">Class} object returned</span>
     <span class="s4">* might have more than one {</span><span class="s5">@code </span><span class="s4">ClassLoader} associated with it.</span>
     <span class="s4">* Subclasses of {</span><span class="s5">@code </span><span class="s4">ClassLoader} need not usually invoke this method,</span>
     <span class="s4">* because most class loaders need to override just {</span><span class="s5">@link</span>
     <span class="s4">* #findClass(String)}.  </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">Class} object for the specified {</span><span class="s5">@code </span><span class="s4">name}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">ClassNotFoundException</span>
     <span class="s4">*          If the class could not be found</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#ClassLoader(ClassLoader)</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#getParent()</span>
     <span class="s4">*/</span>
    <span class="s2">protected final </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">findSystemClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">)</span>
        <span class="s2">throws </span><span class="s1">ClassNotFoundException</span>
    <span class="s3">{</span>
        <span class="s2">return </span><span class="s1">getSystemClassLoader</span><span class="s3">().</span><span class="s1">loadClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns a class loaded by the bootstrap class loader;</span>
     <span class="s4">* or return null if not found.</span>
     <span class="s4">*/</span>
    <span class="s2">static </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">findBootstrapClassOrNull</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(!</span><span class="s1">checkName</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)) </span><span class="s2">return null</span><span class="s3">;</span>

        <span class="s2">return </span><span class="s1">findBootstrapClass</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s0">// return null if not found</span>
    <span class="s2">private static native </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">findBootstrapClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">);</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the class with the given </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">if this</span>
     <span class="s4">* loader has been recorded by the Java virtual machine as an initiating</span>
     <span class="s4">* loader of a class with that </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt;</span><span class="s4">.  Otherwise</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">null} is returned.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">binary name</span><span class="s6">&lt;/a&gt; </span><span class="s4">of the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">Class} object, or {</span><span class="s5">@code </span><span class="s4">null} if the class has</span>
     <span class="s4">*          not been loaded</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.1</span>
     <span class="s4">*/</span>
    <span class="s2">protected final </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">findLoadedClass</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(!</span><span class="s1">checkName</span><span class="s3">(</span><span class="s1">name</span><span class="s3">))</span>
            <span class="s2">return null</span><span class="s3">;</span>
        <span class="s2">return </span><span class="s1">findLoadedClass0</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s2">private final native </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">findLoadedClass0</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">);</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the signers of a class.  This should be invoked after defining a</span>
     <span class="s4">* class.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">c</span>
     <span class="s4">*         The {</span><span class="s5">@code </span><span class="s4">Class} object</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">signers</span>
     <span class="s4">*         The signers for the class</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.1</span>
     <span class="s4">*/</span>
    <span class="s2">protected final void </span><span class="s1">setSigners</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c</span><span class="s3">, </span><span class="s1">Object</span><span class="s3">[] </span><span class="s1">signers</span><span class="s3">) {</span>
        <span class="s1">c</span><span class="s3">.</span><span class="s1">setSigners</span><span class="s3">(</span><span class="s1">signers</span><span class="s3">);</span>
    <span class="s3">}</span>


    <span class="s0">// -- Resources --</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns a URL to a resource in a module defined to this class loader.</span>
     <span class="s4">* Class loader implementations that support loading from modules</span>
     <span class="s4">* should override this method.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">This method is the basis for the {</span><span class="s5">@link</span>
     <span class="s4">* Class#getResource Class.getResource}, {</span><span class="s5">@link </span><span class="s4">Class#getResourceAsStream</span>
     <span class="s4">* Class.getResourceAsStream}, and {</span><span class="s5">@link </span><span class="s4">Module#getResourceAsStream</span>
     <span class="s4">* Module.getResourceAsStream} methods. It is not subject to the rules for</span>
     <span class="s4">* encapsulation specified by {</span><span class="s5">@code </span><span class="s4">Module.getResourceAsStream}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation attempts to find the resource by</span>
     <span class="s4">* invoking {</span><span class="s5">@link </span><span class="s4">#findResource(String)} when the {</span><span class="s5">@code </span><span class="s4">moduleName} is</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">null}. It otherwise returns {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">moduleName</span>
     <span class="s4">*         The module name; or {</span><span class="s5">@code </span><span class="s4">null} to find a resource in the</span>
     <span class="s4">*         {</span><span class="s5">@linkplain </span><span class="s4">#getUnnamedModule() unnamed module} for this</span>
     <span class="s4">*         class loader</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">A URL to the resource; {</span><span class="s5">@code </span><span class="s4">null} if the resource could not be</span>
     <span class="s4">*         found, a URL could not be constructed to locate the resource,</span>
     <span class="s4">*         access to the resource is denied by the security manager, or</span>
     <span class="s4">*         there isn't a module of the given name defined to the class</span>
     <span class="s4">*         loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">IOException</span>
     <span class="s4">*         If I/O errors occur</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">java.lang.module.ModuleReader#find(String)</span>
     <span class="s4">* </span><span class="s5">@since </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">URL findResource</span><span class="s3">(</span><span class="s1">String moduleName</span><span class="s3">, </span><span class="s1">String name</span><span class="s3">) </span><span class="s2">throws </span><span class="s1">IOException </span><span class="s3">{</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">moduleName </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">return </span><span class="s1">findResource</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s2">return null</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Finds the resource with the given name.  A resource is some data</span>
     <span class="s4">* (images, audio, text, etc) that can be accessed by class code in a way</span>
     <span class="s4">* that is independent of the location of the code.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The name of a resource is a '{</span><span class="s5">@code </span><span class="s4">/}'-separated path name that</span>
     <span class="s4">* identifies the resource. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Resources in named modules are subject to the encapsulation rules</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Module#getResourceAsStream Module.getResourceAsStream}.</span>
     <span class="s4">* Additionally, and except for the special case where the resource has a</span>
     <span class="s4">* name ending with &quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot;, this method will only find resources in</span>
     <span class="s4">* packages of named modules when the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String)</span>
     <span class="s4">* opened} unconditionally (even if the caller of this method is in the</span>
     <span class="s4">* same module as the resource). </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation will first search the parent class</span>
     <span class="s4">* loader for the resource; if the parent is {</span><span class="s5">@code </span><span class="s4">null} the path of the</span>
     <span class="s4">* class loader built into the virtual machine is searched. If not found,</span>
     <span class="s4">* this method will invoke {</span><span class="s5">@link </span><span class="s4">#findResource(String)} to find the resource.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">Where several modules are defined to the same class loader,</span>
     <span class="s4">* and where more than one module contains a resource with the given name,</span>
     <span class="s4">* then the ordering that modules are searched is not specified and may be</span>
     <span class="s4">* very unpredictable.</span>
     <span class="s4">* When overriding this method it is recommended that an implementation</span>
     <span class="s4">* ensures that any delegation is consistent with the {</span><span class="s5">@link</span>
     <span class="s4">* #getResources(java.lang.String) getResources(String)} method.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">{</span><span class="s5">@code </span><span class="s4">URL} object for reading the resource; {</span><span class="s5">@code </span><span class="s4">null} if</span>
     <span class="s4">*          the resource could not be found, a {</span><span class="s5">@code </span><span class="s4">URL} could not be</span>
     <span class="s4">*          constructed to locate the resource, the resource is in a package</span>
     <span class="s4">*          that is not opened unconditionally, or access to the resource is</span>
     <span class="s4">*          denied by the security manager.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NullPointerException If {</span><span class="s5">@code </span><span class="s4">name} is {</span><span class="s5">@code </span><span class="s4">null}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.1</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public </span><span class="s1">URL getResource</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s1">Objects</span><span class="s3">.</span><span class="s1">requireNonNull</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s1">URL url</span><span class="s3">;</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">parent </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">url </span><span class="s3">= </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">getResource</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s1">url </span><span class="s3">= </span><span class="s1">BootLoader</span><span class="s3">.</span><span class="s1">findResource</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">url </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">url </span><span class="s3">= </span><span class="s1">findResource</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">url</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Finds all the resources with the given name. A resource is some data</span>
     <span class="s4">* (images, audio, text, etc) that can be accessed by class code in a way</span>
     <span class="s4">* that is independent of the location of the code.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The name of a resource is a {</span><span class="s5">@code </span><span class="s4">/}-separated path name that</span>
     <span class="s4">* identifies the resource. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Resources in named modules are subject to the encapsulation rules</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Module#getResourceAsStream Module.getResourceAsStream}.</span>
     <span class="s4">* Additionally, and except for the special case where the resource has a</span>
     <span class="s4">* name ending with &quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot;, this method will only find resources in</span>
     <span class="s4">* packages of named modules when the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String)</span>
     <span class="s4">* opened} unconditionally (even if the caller of this method is in the</span>
     <span class="s4">* same module as the resource). </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation will first search the parent class</span>
     <span class="s4">* loader for the resource; if the parent is {</span><span class="s5">@code </span><span class="s4">null} the path of the</span>
     <span class="s4">* class loader built into the virtual machine is searched. It then</span>
     <span class="s4">* invokes {</span><span class="s5">@link </span><span class="s4">#findResources(String)} to find the resources with the</span>
     <span class="s4">* name in this class loader. It returns an enumeration whose elements</span>
     <span class="s4">* are the URLs found by searching the parent class loader followed by</span>
     <span class="s4">* the elements found with {</span><span class="s5">@code </span><span class="s4">findResources}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">Where several modules are defined to the same class loader,</span>
     <span class="s4">* and where more than one module contains a resource with the given name,</span>
     <span class="s4">* then the ordering is not specified and may be very unpredictable.</span>
     <span class="s4">* When overriding this method it is recommended that an</span>
     <span class="s4">* implementation ensures that any delegation is consistent with the {</span><span class="s5">@link</span>
     <span class="s4">* #getResource(java.lang.String) getResource(String)} method. This should</span>
     <span class="s4">* ensure that the first element returned by the Enumeration's</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">nextElement} method is the same resource that the</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">getResource(String)} method would return.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">An enumeration of {</span><span class="s5">@link </span><span class="s4">java.net.URL URL} objects for the</span>
     <span class="s4">*          resource. If no resources could be found, the enumeration will</span>
     <span class="s4">*          be empty. Resources for which a {</span><span class="s5">@code </span><span class="s4">URL} cannot be</span>
     <span class="s4">*          constructed, are in a package that is not opened</span>
     <span class="s4">*          unconditionally, or access to the resource is denied by the</span>
     <span class="s4">*          security manager, are not returned in the enumeration.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">IOException</span>
     <span class="s4">*          If I/O errors occur</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NullPointerException If {</span><span class="s5">@code </span><span class="s4">name} is {</span><span class="s5">@code </span><span class="s4">null}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public </span><span class="s1">Enumeration</span><span class="s3">&lt;</span><span class="s1">URL</span><span class="s3">&gt; </span><span class="s1">getResources</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) </span><span class="s2">throws </span><span class="s1">IOException </span><span class="s3">{</span>
        <span class="s1">Objects</span><span class="s3">.</span><span class="s1">requireNonNull</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s1">@SuppressWarnings</span><span class="s3">(</span><span class="s8">&quot;unchecked&quot;</span><span class="s3">)</span>
        <span class="s1">Enumeration</span><span class="s3">&lt;</span><span class="s1">URL</span><span class="s3">&gt;[] </span><span class="s1">tmp </span><span class="s3">= (</span><span class="s1">Enumeration</span><span class="s3">&lt;</span><span class="s1">URL</span><span class="s3">&gt;[]) </span><span class="s2">new </span><span class="s1">Enumeration</span><span class="s3">&lt;?&gt;[</span><span class="s7">2</span><span class="s3">];</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">parent </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">tmp</span><span class="s3">[</span><span class="s7">0</span><span class="s3">] = </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">getResources</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s1">tmp</span><span class="s3">[</span><span class="s7">0</span><span class="s3">] = </span><span class="s1">BootLoader</span><span class="s3">.</span><span class="s1">findResources</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s1">tmp</span><span class="s3">[</span><span class="s7">1</span><span class="s3">] = </span><span class="s1">findResources</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>

        <span class="s2">return new </span><span class="s1">CompoundEnumeration</span><span class="s3">&lt;&gt;(</span><span class="s1">tmp</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns a stream whose elements are the URLs of all the resources with</span>
     <span class="s4">* the given name. A resource is some data (images, audio, text, etc) that</span>
     <span class="s4">* can be accessed by class code in a way that is independent of the</span>
     <span class="s4">* location of the code.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The name of a resource is a {</span><span class="s5">@code </span><span class="s4">/}-separated path name that</span>
     <span class="s4">* identifies the resource.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The resources will be located when the returned stream is evaluated.</span>
     <span class="s4">* If the evaluation results in an {</span><span class="s5">@code </span><span class="s4">IOException} then the I/O</span>
     <span class="s4">* exception is wrapped in an {</span><span class="s5">@link </span><span class="s4">UncheckedIOException} that is then</span>
     <span class="s4">* thrown.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Resources in named modules are subject to the encapsulation rules</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Module#getResourceAsStream Module.getResourceAsStream}.</span>
     <span class="s4">* Additionally, and except for the special case where the resource has a</span>
     <span class="s4">* name ending with &quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot;, this method will only find resources in</span>
     <span class="s4">* packages of named modules when the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String)</span>
     <span class="s4">* opened} unconditionally (even if the caller of this method is in the</span>
     <span class="s4">* same module as the resource). </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation invokes {</span><span class="s5">@link </span><span class="s4">#getResources(String)</span>
     <span class="s4">* getResources} to find all the resources with the given name and returns</span>
     <span class="s4">* a stream with the elements in the enumeration as the source.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">When overriding this method it is recommended that an</span>
     <span class="s4">* implementation ensures that any delegation is consistent with the {</span><span class="s5">@link</span>
     <span class="s4">* #getResource(java.lang.String) getResource(String)} method. This should</span>
     <span class="s4">* ensure that the first element returned by the stream is the same</span>
     <span class="s4">* resource that the {</span><span class="s5">@code </span><span class="s4">getResource(String)} method would return.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">A stream of resource {</span><span class="s5">@link </span><span class="s4">java.net.URL URL} objects. If no</span>
     <span class="s4">*          resources could  be found, the stream will be empty. Resources</span>
     <span class="s4">*          for which a {</span><span class="s5">@code </span><span class="s4">URL} cannot be constructed, are in a package</span>
     <span class="s4">*          that is not opened unconditionally, or access to the resource</span>
     <span class="s4">*          is denied by the security manager, will not be in the stream.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NullPointerException If {</span><span class="s5">@code </span><span class="s4">name} is {</span><span class="s5">@code </span><span class="s4">null}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public </span><span class="s1">Stream</span><span class="s3">&lt;</span><span class="s1">URL</span><span class="s3">&gt; </span><span class="s1">resources</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s1">Objects</span><span class="s3">.</span><span class="s1">requireNonNull</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">int </span><span class="s1">characteristics </span><span class="s3">= </span><span class="s1">Spliterator</span><span class="s3">.</span><span class="s1">NONNULL </span><span class="s3">| </span><span class="s1">Spliterator</span><span class="s3">.</span><span class="s1">IMMUTABLE</span><span class="s3">;</span>
        <span class="s1">Supplier</span><span class="s3">&lt;</span><span class="s1">Spliterator</span><span class="s3">&lt;</span><span class="s1">URL</span><span class="s3">&gt;&gt; </span><span class="s1">si </span><span class="s3">= () </span><span class="s1">-&gt; </span><span class="s3">{</span>
            <span class="s2">try </span><span class="s3">{</span>
                <span class="s2">return </span><span class="s1">Spliterators</span><span class="s3">.</span><span class="s1">spliteratorUnknownSize</span><span class="s3">(</span>
                    <span class="s1">getResources</span><span class="s3">(</span><span class="s1">name</span><span class="s3">).</span><span class="s1">asIterator</span><span class="s3">(), </span><span class="s1">characteristics</span><span class="s3">);</span>
            <span class="s3">} </span><span class="s2">catch </span><span class="s3">(</span><span class="s1">IOException e</span><span class="s3">) {</span>
                <span class="s2">throw new </span><span class="s1">UncheckedIOException</span><span class="s3">(</span><span class="s1">e</span><span class="s3">);</span>
            <span class="s3">}</span>
        <span class="s3">};</span>
        <span class="s2">return </span><span class="s1">StreamSupport</span><span class="s3">.</span><span class="s1">stream</span><span class="s3">(</span><span class="s1">si</span><span class="s3">, </span><span class="s1">characteristics</span><span class="s3">, </span><span class="s2">false</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Finds the resource with the given name. Class loader implementations</span>
     <span class="s4">* should override this method.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">For resources in named modules then the method must implement the</span>
     <span class="s4">* rules for encapsulation specified in the {</span><span class="s5">@code </span><span class="s4">Module} {</span><span class="s5">@link</span>
     <span class="s4">* Module#getResourceAsStream getResourceAsStream} method. Additionally,</span>
     <span class="s4">* it must not find non-&quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot; resources in packages of named</span>
     <span class="s4">* modules unless the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String) opened}</span>
     <span class="s4">* unconditionally. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation returns {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">{</span><span class="s5">@code </span><span class="s4">URL} object for reading the resource; {</span><span class="s5">@code </span><span class="s4">null} if</span>
     <span class="s4">*          the resource could not be found, a {</span><span class="s5">@code </span><span class="s4">URL} could not be</span>
     <span class="s4">*          constructed to locate the resource, the resource is in a package</span>
     <span class="s4">*          that is not opened unconditionally, or access to the resource is</span>
     <span class="s4">*          denied by the security manager.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">URL findResource</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s2">return null</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns an enumeration of {</span><span class="s5">@link </span><span class="s4">java.net.URL URL} objects</span>
     <span class="s4">* representing all the resources with the given name. Class loader</span>
     <span class="s4">* implementations should override this method.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">For resources in named modules then the method must implement the</span>
     <span class="s4">* rules for encapsulation specified in the {</span><span class="s5">@code </span><span class="s4">Module} {</span><span class="s5">@link</span>
     <span class="s4">* Module#getResourceAsStream getResourceAsStream} method. Additionally,</span>
     <span class="s4">* it must not find non-&quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot; resources in packages of named</span>
     <span class="s4">* modules unless the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String) opened}</span>
     <span class="s4">* unconditionally. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implSpec </span><span class="s4">The default implementation returns an enumeration that</span>
     <span class="s4">* contains no elements.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">An enumeration of {</span><span class="s5">@link </span><span class="s4">java.net.URL URL} objects for</span>
     <span class="s4">*          the resource. If no resources could  be found, the enumeration</span>
     <span class="s4">*          will be empty. Resources for which a {</span><span class="s5">@code </span><span class="s4">URL} cannot be</span>
     <span class="s4">*          constructed, are in a package that is not opened unconditionally,</span>
     <span class="s4">*          or access to the resource is denied by the security manager,</span>
     <span class="s4">*          are not returned in the enumeration.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">IOException</span>
     <span class="s4">*          If I/O errors occur</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">Enumeration</span><span class="s3">&lt;</span><span class="s1">URL</span><span class="s3">&gt; </span><span class="s1">findResources</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) </span><span class="s2">throws </span><span class="s1">IOException </span><span class="s3">{</span>
        <span class="s2">return </span><span class="s1">Collections</span><span class="s3">.</span><span class="s1">emptyEnumeration</span><span class="s3">();</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Registers the caller as</span>
     <span class="s4">* {</span><span class="s5">@linkplain </span><span class="s4">#isRegisteredAsParallelCapable() parallel capable}.</span>
     <span class="s4">* The registration succeeds if and only if all of the following</span>
     <span class="s4">* conditions are met:</span>
     <span class="s4">* </span><span class="s6">&lt;ol&gt;</span>
     <span class="s4">* </span><span class="s6">&lt;li&gt; </span><span class="s4">no instance of the caller has been created</span><span class="s6">&lt;/li&gt;</span>
     <span class="s4">* </span><span class="s6">&lt;li&gt; </span><span class="s4">all of the super classes (except class Object) of the caller are</span>
     <span class="s4">* registered as parallel capable</span><span class="s6">&lt;/li&gt;</span>
     <span class="s4">* </span><span class="s6">&lt;/ol&gt;</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt;</span><span class="s4">Note that once a class loader is registered as parallel capable, there</span>
     <span class="s4">* is no way to change it back.</span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt;</span>
     <span class="s4">* In cases where this method is called from a context where the caller is</span>
     <span class="s4">* not a subclass of {</span><span class="s5">@code </span><span class="s4">ClassLoader} or there is no caller frame on the</span>
     <span class="s4">* stack (e.g. when called directly from a JNI attached thread),</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">IllegalCallerException} is thrown.</span>
     <span class="s4">* </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">{</span><span class="s5">@code </span><span class="s4">true} if the caller is successfully registered as</span>
     <span class="s4">*          parallel capable and {</span><span class="s5">@code </span><span class="s4">false} if otherwise.</span>
     <span class="s4">* </span><span class="s5">@throws </span><span class="s4">IllegalCallerException if the caller is not a subclass of {</span><span class="s5">@code </span><span class="s4">ClassLoader}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">#isRegisteredAsParallelCapable()</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since   </span><span class="s4">1.7</span>
     <span class="s4">*/</span>
    <span class="s1">@CallerSensitive</span>
    <span class="s2">protected static boolean </span><span class="s1">registerAsParallelCapable</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">registerAsParallelCapable</span><span class="s3">(</span><span class="s1">Reflection</span><span class="s3">.</span><span class="s1">getCallerClass</span><span class="s3">());</span>
    <span class="s3">}</span>

    <span class="s0">// Caller-sensitive adapter method for reflective invocation</span>
    <span class="s1">@CallerSensitiveAdapter</span>
    <span class="s2">private static boolean </span><span class="s1">registerAsParallelCapable</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">caller</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">((</span><span class="s1">caller </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) || !</span><span class="s1">ClassLoader</span><span class="s3">.</span><span class="s2">class</span><span class="s3">.</span><span class="s1">isAssignableFrom</span><span class="s3">(</span><span class="s1">caller</span><span class="s3">)) {</span>
            <span class="s2">throw new </span><span class="s1">IllegalCallerException</span><span class="s3">(</span><span class="s1">caller </span><span class="s3">+ </span><span class="s8">&quot; not a subclass of ClassLoader&quot;</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">ParallelLoaders</span><span class="s3">.</span><span class="s1">register</span><span class="s3">(</span><span class="s1">caller</span><span class="s3">.</span><span class="s1">asSubclass</span><span class="s3">(</span><span class="s1">ClassLoader</span><span class="s3">.</span><span class="s2">class</span><span class="s3">));</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns {</span><span class="s5">@code </span><span class="s4">true} if this class loader is registered as</span>
     <span class="s4">* {</span><span class="s5">@linkplain </span><span class="s4">#registerAsParallelCapable parallel capable}, otherwise</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">false}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">{</span><span class="s5">@code </span><span class="s4">true} if this class loader is parallel capable,</span>
     <span class="s4">*          otherwise {</span><span class="s5">@code </span><span class="s4">false}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">#registerAsParallelCapable()</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since   </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public final boolean </span><span class="s1">isRegisteredAsParallelCapable</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">ParallelLoaders</span><span class="s3">.</span><span class="s1">isRegistered</span><span class="s3">(</span><span class="s2">this</span><span class="s3">.</span><span class="s1">getClass</span><span class="s3">());</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Find a resource of the specified name from the search path used to load</span>
     <span class="s4">* classes.  This method locates the resource through the system class</span>
     <span class="s4">* loader (see {</span><span class="s5">@link </span><span class="s4">#getSystemClassLoader()}).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Resources in named modules are subject to the encapsulation rules</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Module#getResourceAsStream Module.getResourceAsStream}.</span>
     <span class="s4">* Additionally, and except for the special case where the resource has a</span>
     <span class="s4">* name ending with &quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot;, this method will only find resources in</span>
     <span class="s4">* packages of named modules when the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String)</span>
     <span class="s4">* opened} unconditionally. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">A {</span><span class="s5">@link </span><span class="s4">java.net.URL URL} to the resource; {</span><span class="s5">@code</span>
     <span class="s4">*          null} if the resource could not be found, a URL could not be</span>
     <span class="s4">*          constructed to locate the resource, the resource is in a package</span>
     <span class="s4">*          that is not opened unconditionally or access to the resource is</span>
     <span class="s4">*          denied by the security manager.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.1</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public static </span><span class="s1">URL getSystemResource</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s2">return </span><span class="s1">getSystemClassLoader</span><span class="s3">().</span><span class="s1">getResource</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Finds all resources of the specified name from the search path used to</span>
     <span class="s4">* load classes.  The resources thus found are returned as an</span>
     <span class="s4">* {</span><span class="s5">@link </span><span class="s4">java.util.Enumeration Enumeration} of {</span><span class="s5">@link</span>
     <span class="s4">* java.net.URL URL} objects.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The search order is described in the documentation for {</span><span class="s5">@link</span>
     <span class="s4">* #getSystemResource(String)}.  </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Resources in named modules are subject to the encapsulation rules</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Module#getResourceAsStream Module.getResourceAsStream}.</span>
     <span class="s4">* Additionally, and except for the special case where the resource has a</span>
     <span class="s4">* name ending with &quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot;, this method will only find resources in</span>
     <span class="s4">* packages of named modules when the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String)</span>
     <span class="s4">* opened} unconditionally. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">An enumeration of {</span><span class="s5">@link </span><span class="s4">java.net.URL URL} objects for</span>
     <span class="s4">*          the resource. If no resources could  be found, the enumeration</span>
     <span class="s4">*          will be empty. Resources for which a {</span><span class="s5">@code </span><span class="s4">URL} cannot be</span>
     <span class="s4">*          constructed, are in a package that is not opened unconditionally,</span>
     <span class="s4">*          or access to the resource is denied by the security manager,</span>
     <span class="s4">*          are not returned in the enumeration.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">IOException</span>
     <span class="s4">*          If I/O errors occur</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public static </span><span class="s1">Enumeration</span><span class="s3">&lt;</span><span class="s1">URL</span><span class="s3">&gt; </span><span class="s1">getSystemResources</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">)</span>
        <span class="s2">throws </span><span class="s1">IOException</span>
    <span class="s3">{</span>
        <span class="s2">return </span><span class="s1">getSystemClassLoader</span><span class="s3">().</span><span class="s1">getResources</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns an input stream for reading the specified resource.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The search order is described in the documentation for {</span><span class="s5">@link</span>
     <span class="s4">* #getResource(String)}.  </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Resources in named modules are subject to the encapsulation rules</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Module#getResourceAsStream Module.getResourceAsStream}.</span>
     <span class="s4">* Additionally, and except for the special case where the resource has a</span>
     <span class="s4">* name ending with &quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot;, this method will only find resources in</span>
     <span class="s4">* packages of named modules when the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String)</span>
     <span class="s4">* opened} unconditionally. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">An input stream for reading the resource; {</span><span class="s5">@code </span><span class="s4">null} if the</span>
     <span class="s4">*          resource could not be found, the resource is in a package that</span>
     <span class="s4">*          is not opened unconditionally, or access to the resource is</span>
     <span class="s4">*          denied by the security manager.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NullPointerException If {</span><span class="s5">@code </span><span class="s4">name} is {</span><span class="s5">@code </span><span class="s4">null}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.1</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public </span><span class="s1">InputStream getResourceAsStream</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s1">Objects</span><span class="s3">.</span><span class="s1">requireNonNull</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s1">URL url </span><span class="s3">= </span><span class="s1">getResource</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">try </span><span class="s3">{</span>
            <span class="s2">return </span><span class="s1">url </span><span class="s3">!= </span><span class="s2">null </span><span class="s3">? </span><span class="s1">url</span><span class="s3">.</span><span class="s1">openStream</span><span class="s3">() : </span><span class="s2">null</span><span class="s3">;</span>
        <span class="s3">} </span><span class="s2">catch </span><span class="s3">(</span><span class="s1">IOException e</span><span class="s3">) {</span>
            <span class="s2">return null</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Open for reading, a resource of the specified name from the search path</span>
     <span class="s4">* used to load classes.  This method locates the resource through the</span>
     <span class="s4">* system class loader (see {</span><span class="s5">@link </span><span class="s4">#getSystemClassLoader()}).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Resources in named modules are subject to the encapsulation rules</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Module#getResourceAsStream Module.getResourceAsStream}.</span>
     <span class="s4">* Additionally, and except for the special case where the resource has a</span>
     <span class="s4">* name ending with &quot;{</span><span class="s5">@code </span><span class="s4">.class}&quot;, this method will only find resources in</span>
     <span class="s4">* packages of named modules when the package is {</span><span class="s5">@link </span><span class="s4">Module#isOpen(String)</span>
     <span class="s4">* opened} unconditionally. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The resource name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">An input stream for reading the resource; {</span><span class="s5">@code </span><span class="s4">null} if the</span>
     <span class="s4">*          resource could not be found, the resource is in a package that</span>
     <span class="s4">*          is not opened unconditionally, or access to the resource is</span>
     <span class="s4">*          denied by the security manager.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.1</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public static </span><span class="s1">InputStream getSystemResourceAsStream</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s1">URL url </span><span class="s3">= </span><span class="s1">getSystemResource</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">try </span><span class="s3">{</span>
            <span class="s2">return </span><span class="s1">url </span><span class="s3">!= </span><span class="s2">null </span><span class="s3">? </span><span class="s1">url</span><span class="s3">.</span><span class="s1">openStream</span><span class="s3">() : </span><span class="s2">null</span><span class="s3">;</span>
        <span class="s3">} </span><span class="s2">catch </span><span class="s3">(</span><span class="s1">IOException e</span><span class="s3">) {</span>
            <span class="s2">return null</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>


    <span class="s0">// -- Hierarchy --</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the parent class loader for delegation. Some implementations may</span>
     <span class="s4">* use {</span><span class="s5">@code </span><span class="s4">null} to represent the bootstrap class loader. This method</span>
     <span class="s4">* will return {</span><span class="s5">@code </span><span class="s4">null} in such implementations if this class loader's</span>
     <span class="s4">* parent is the bootstrap class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The parent {</span><span class="s5">@code </span><span class="s4">ClassLoader}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">SecurityException</span>
     <span class="s4">*          If a security manager is present, and the caller's class loader</span>
     <span class="s4">*          is not {</span><span class="s5">@code </span><span class="s4">null} and is not an ancestor of this class loader,</span>
     <span class="s4">*          and the caller does not have the</span>
     <span class="s4">*          {</span><span class="s5">@link </span><span class="s4">RuntimePermission}{</span><span class="s5">@code </span><span class="s4">(&quot;getClassLoader&quot;)}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">*/</span>
    <span class="s1">@CallerSensitive</span>
    <span class="s2">public final </span><span class="s1">ClassLoader getParent</span><span class="s3">() {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">parent </span><span class="s3">== </span><span class="s2">null</span><span class="s3">)</span>
            <span class="s2">return null</span><span class="s3">;</span>
        <span class="s1">@SuppressWarnings</span><span class="s3">(</span><span class="s8">&quot;removal&quot;</span><span class="s3">)</span>
        <span class="s1">SecurityManager sm </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">getSecurityManager</span><span class="s3">();</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">sm </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s0">// Check access to the parent class loader</span>
            <span class="s0">// If the caller's class loader is same as this class loader,</span>
            <span class="s0">// permission check is performed.</span>
            <span class="s1">checkClassLoaderPermission</span><span class="s3">(</span><span class="s1">parent</span><span class="s3">, </span><span class="s1">Reflection</span><span class="s3">.</span><span class="s1">getCallerClass</span><span class="s3">());</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">parent</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the unnamed {</span><span class="s5">@code </span><span class="s4">Module} for this class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">The unnamed Module for this class loader</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">Module#isNamed()</span>
     <span class="s4">* </span><span class="s5">@since </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public final </span><span class="s1">Module getUnnamedModule</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">unnamedModule</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the platform class loader.  All</span>
     <span class="s4">* </span><span class="s6">&lt;a href=&quot;#builtinLoaders&quot;&gt;</span><span class="s4">platform classes</span><span class="s6">&lt;/a&gt; </span><span class="s4">are visible to</span>
     <span class="s4">* the platform class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implNote </span><span class="s4">The name of the builtin platform class loader is</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">&quot;platform&quot;}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The platform {</span><span class="s5">@code </span><span class="s4">ClassLoader}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">SecurityException</span>
     <span class="s4">*          If a security manager is present, and the caller's class loader is</span>
     <span class="s4">*          not {</span><span class="s5">@code </span><span class="s4">null}, and the caller's class loader is not the same</span>
     <span class="s4">*          as or an ancestor of the platform class loader,</span>
     <span class="s4">*          and the caller does not have the</span>
     <span class="s4">*          {</span><span class="s5">@link </span><span class="s4">RuntimePermission}{</span><span class="s5">@code </span><span class="s4">(&quot;getClassLoader&quot;)}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s1">@CallerSensitive</span>
    <span class="s2">public static </span><span class="s1">ClassLoader getPlatformClassLoader</span><span class="s3">() {</span>
        <span class="s1">@SuppressWarnings</span><span class="s3">(</span><span class="s8">&quot;removal&quot;</span><span class="s3">)</span>
        <span class="s1">SecurityManager sm </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">getSecurityManager</span><span class="s3">();</span>
        <span class="s1">ClassLoader loader </span><span class="s3">= </span><span class="s1">getBuiltinPlatformClassLoader</span><span class="s3">();</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">sm </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">checkClassLoaderPermission</span><span class="s3">(</span><span class="s1">loader</span><span class="s3">, </span><span class="s1">Reflection</span><span class="s3">.</span><span class="s1">getCallerClass</span><span class="s3">());</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">loader</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the system class loader.  This is the default</span>
     <span class="s4">* delegation parent for new {</span><span class="s5">@code </span><span class="s4">ClassLoader} instances, and is</span>
     <span class="s4">* typically the class loader used to start the application.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">This method is first invoked early in the runtime's startup</span>
     <span class="s4">* sequence, at which point it creates the system class loader. This</span>
     <span class="s4">* class loader will be the context class loader for the main application</span>
     <span class="s4">* thread (for example, the thread that invokes the {</span><span class="s5">@code </span><span class="s4">main} method of</span>
     <span class="s4">* the main class).</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The default system class loader is an implementation-dependent</span>
     <span class="s4">* instance of this class.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">If the system property &quot;{</span><span class="s5">@systemProperty </span><span class="s4">java.system.class.loader}&quot;</span>
     <span class="s4">* is defined when this method is first invoked then the value of that</span>
     <span class="s4">* property is taken to be the name of a class that will be returned as the</span>
     <span class="s4">* system class loader. The class is loaded using the default system class</span>
     <span class="s4">* loader and must define a public constructor that takes a single parameter</span>
     <span class="s4">* of type {</span><span class="s5">@code </span><span class="s4">ClassLoader} which is used as the delegation parent. An</span>
     <span class="s4">* instance is then created using this constructor with the default system</span>
     <span class="s4">* class loader as the parameter.  The resulting class loader is defined</span>
     <span class="s4">* to be the system class loader. During construction, the class loader</span>
     <span class="s4">* should take great care to avoid calling {</span><span class="s5">@code </span><span class="s4">getSystemClassLoader()}.</span>
     <span class="s4">* If circular initialization of the system class loader is detected then</span>
     <span class="s4">* an {</span><span class="s5">@code </span><span class="s4">IllegalStateException} is thrown.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@implNote </span><span class="s4">The system property to override the system class loader is not</span>
     <span class="s4">* examined until the VM is almost fully initialized. Code that executes</span>
     <span class="s4">* this method during startup should take care not to cache the return</span>
     <span class="s4">* value until the system is fully initialized.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">The name of the built-in system class loader is {</span><span class="s5">@code </span><span class="s4">&quot;app&quot;}.</span>
     <span class="s4">* The system property &quot;{</span><span class="s5">@code </span><span class="s4">java.class.path}&quot; is read during early</span>
     <span class="s4">* initialization of the VM to determine the class path.</span>
     <span class="s4">* An empty value of &quot;{</span><span class="s5">@code </span><span class="s4">java.class.path}&quot; property is interpreted</span>
     <span class="s4">* differently depending on whether the initial module (the module</span>
     <span class="s4">* containing the main class) is named or unnamed:</span>
     <span class="s4">* If named, the built-in system class loader will have no class path and</span>
     <span class="s4">* will search for classes and resources using the application module path;</span>
     <span class="s4">* otherwise, if unnamed, it will set the class path to the current</span>
     <span class="s4">* working directory.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">JAR files on the class path may contain a {</span><span class="s5">@code </span><span class="s4">Class-Path} manifest</span>
     <span class="s4">* attribute to specify dependent JAR files to be included in the class path.</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">Class-Path} entries must meet certain conditions for validity (see</span>
     <span class="s4">* the </span><span class="s6">&lt;a href=&quot;</span><span class="s4">{</span><span class="s5">@docRoot</span><span class="s4">}/../specs/jar/jar.html#class-path-attribute&quot;&gt;</span>
     <span class="s4">* JAR File Specification</span><span class="s6">&lt;/a&gt; </span><span class="s4">for details).  Invalid {</span><span class="s5">@code </span><span class="s4">Class-Path}</span>
     <span class="s4">* entries are ignored.  For debugging purposes, ignored entries can be</span>
     <span class="s4">* printed to the console if the</span>
     <span class="s4">* {</span><span class="s5">@systemProperty </span><span class="s4">jdk.net.URLClassPath.showIgnoredClassPathEntries} system</span>
     <span class="s4">* property is set to {</span><span class="s5">@code </span><span class="s4">true}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The system {</span><span class="s5">@code </span><span class="s4">ClassLoader}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">SecurityException</span>
     <span class="s4">*          If a security manager is present, and the caller's class loader</span>
     <span class="s4">*          is not {</span><span class="s5">@code </span><span class="s4">null} and is not the same as or an ancestor of the</span>
     <span class="s4">*          system class loader, and the caller does not have the</span>
     <span class="s4">*          {</span><span class="s5">@link </span><span class="s4">RuntimePermission}{</span><span class="s5">@code </span><span class="s4">(&quot;getClassLoader&quot;)}</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">IllegalStateException</span>
     <span class="s4">*          If invoked recursively during the construction of the class</span>
     <span class="s4">*          loader specified by the &quot;{</span><span class="s5">@code </span><span class="s4">java.system.class.loader}&quot;</span>
     <span class="s4">*          property.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">Error</span>
     <span class="s4">*          If the system property &quot;{</span><span class="s5">@code </span><span class="s4">java.system.class.loader}&quot;</span>
     <span class="s4">*          is defined but the named class could not be loaded, the</span>
     <span class="s4">*          provider class does not define the required constructor, or an</span>
     <span class="s4">*          exception is thrown by that constructor when it is invoked. The</span>
     <span class="s4">*          underlying cause of the error can be retrieved via the</span>
     <span class="s4">*          {</span><span class="s5">@link </span><span class="s4">Throwable#getCause()} method.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@revised  </span><span class="s4">1.4</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s1">@CallerSensitive</span>
    <span class="s2">public static </span><span class="s1">ClassLoader getSystemClassLoader</span><span class="s3">() {</span>
        <span class="s2">switch </span><span class="s3">(</span><span class="s1">VM</span><span class="s3">.</span><span class="s1">initLevel</span><span class="s3">()) {</span>
            <span class="s2">case </span><span class="s7">0</span><span class="s3">:</span>
            <span class="s2">case </span><span class="s7">1</span><span class="s3">:</span>
            <span class="s2">case </span><span class="s7">2</span><span class="s3">:</span>
                <span class="s0">// the system class loader is the built-in app class loader during startup</span>
                <span class="s2">return </span><span class="s1">getBuiltinAppClassLoader</span><span class="s3">();</span>
            <span class="s2">case </span><span class="s7">3</span><span class="s3">:</span>
                <span class="s1">String msg </span><span class="s3">= </span><span class="s8">&quot;getSystemClassLoader cannot be called during the system class loader instantiation&quot;</span><span class="s3">;</span>
                <span class="s2">throw new </span><span class="s1">IllegalStateException</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">);</span>
            <span class="s2">default</span><span class="s3">:</span>
                <span class="s0">// system fully initialized</span>
                <span class="s2">assert </span><span class="s1">VM</span><span class="s3">.</span><span class="s1">isBooted</span><span class="s3">() &amp;&amp; </span><span class="s1">scl </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">;</span>
                <span class="s1">@SuppressWarnings</span><span class="s3">(</span><span class="s8">&quot;removal&quot;</span><span class="s3">)</span>
                <span class="s1">SecurityManager sm </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">getSecurityManager</span><span class="s3">();</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">sm </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
                    <span class="s1">checkClassLoaderPermission</span><span class="s3">(</span><span class="s1">scl</span><span class="s3">, </span><span class="s1">Reflection</span><span class="s3">.</span><span class="s1">getCallerClass</span><span class="s3">());</span>
                <span class="s3">}</span>
                <span class="s2">return </span><span class="s1">scl</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s2">static </span><span class="s1">ClassLoader getBuiltinPlatformClassLoader</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">ClassLoaders</span><span class="s3">.</span><span class="s1">platformClassLoader</span><span class="s3">();</span>
    <span class="s3">}</span>

    <span class="s2">static </span><span class="s1">ClassLoader getBuiltinAppClassLoader</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">ClassLoaders</span><span class="s3">.</span><span class="s1">appClassLoader</span><span class="s3">();</span>
    <span class="s3">}</span>

    <span class="s0">/* 
     * Initialize the system class loader that may be a custom class on the 
     * application class path or application module path. 
     * 
     * @see java.lang.System#initPhase3 
     */</span>
    <span class="s2">static synchronized </span><span class="s1">ClassLoader initSystemClassLoader</span><span class="s3">() {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">VM</span><span class="s3">.</span><span class="s1">initLevel</span><span class="s3">() != </span><span class="s7">3</span><span class="s3">) {</span>
            <span class="s2">throw new </span><span class="s1">InternalError</span><span class="s3">(</span><span class="s8">&quot;system class loader cannot be set at initLevel &quot; </span><span class="s3">+</span>
                                    <span class="s1">VM</span><span class="s3">.</span><span class="s1">initLevel</span><span class="s3">());</span>
        <span class="s3">}</span>

        <span class="s0">// detect recursive initialization</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">scl </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">throw new </span><span class="s1">IllegalStateException</span><span class="s3">(</span><span class="s8">&quot;recursive invocation&quot;</span><span class="s3">);</span>
        <span class="s3">}</span>

        <span class="s1">ClassLoader builtinLoader </span><span class="s3">= </span><span class="s1">getBuiltinAppClassLoader</span><span class="s3">();</span>

        <span class="s0">// All are privileged frames.  No need to call doPrivileged.</span>
        <span class="s1">String cn </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">getProperty</span><span class="s3">(</span><span class="s8">&quot;java.system.class.loader&quot;</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">cn </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">try </span><span class="s3">{</span>
                <span class="s0">// custom class loader is only supported to be loaded from unnamed module</span>
                <span class="s1">Constructor</span><span class="s3">&lt;?&gt; </span><span class="s1">ctor </span><span class="s3">= </span><span class="s1">Class</span><span class="s3">.</span><span class="s1">forName</span><span class="s3">(</span><span class="s1">cn</span><span class="s3">, </span><span class="s2">false</span><span class="s3">, </span><span class="s1">builtinLoader</span><span class="s3">)</span>
                                           <span class="s3">.</span><span class="s1">getDeclaredConstructor</span><span class="s3">(</span><span class="s1">ClassLoader</span><span class="s3">.</span><span class="s2">class</span><span class="s3">);</span>
                <span class="s1">scl </span><span class="s3">= (</span><span class="s1">ClassLoader</span><span class="s3">) </span><span class="s1">ctor</span><span class="s3">.</span><span class="s1">newInstance</span><span class="s3">(</span><span class="s1">builtinLoader</span><span class="s3">);</span>
            <span class="s3">} </span><span class="s2">catch </span><span class="s3">(</span><span class="s1">Exception e</span><span class="s3">) {</span>
                <span class="s1">Throwable cause </span><span class="s3">= </span><span class="s1">e</span><span class="s3">;</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">e </span><span class="s2">instanceof </span><span class="s1">InvocationTargetException</span><span class="s3">) {</span>
                    <span class="s1">cause </span><span class="s3">= </span><span class="s1">e</span><span class="s3">.</span><span class="s1">getCause</span><span class="s3">();</span>
                    <span class="s2">if </span><span class="s3">(</span><span class="s1">cause </span><span class="s2">instanceof </span><span class="s1">Error</span><span class="s3">) {</span>
                        <span class="s2">throw </span><span class="s3">(</span><span class="s1">Error</span><span class="s3">) </span><span class="s1">cause</span><span class="s3">;</span>
                    <span class="s3">}</span>
                <span class="s3">}</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">cause </span><span class="s2">instanceof </span><span class="s1">RuntimeException</span><span class="s3">) {</span>
                    <span class="s2">throw </span><span class="s3">(</span><span class="s1">RuntimeException</span><span class="s3">) </span><span class="s1">cause</span><span class="s3">;</span>
                <span class="s3">}</span>
                <span class="s2">throw new </span><span class="s1">Error</span><span class="s3">(</span><span class="s1">cause</span><span class="s3">.</span><span class="s1">getMessage</span><span class="s3">(), </span><span class="s1">cause</span><span class="s3">);</span>
            <span class="s3">}</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s1">scl </span><span class="s3">= </span><span class="s1">builtinLoader</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">scl</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// Returns true if the specified class loader can be found in this class</span>
    <span class="s0">// loader's delegation chain.</span>
    <span class="s2">boolean </span><span class="s1">isAncestor</span><span class="s3">(</span><span class="s1">ClassLoader cl</span><span class="s3">) {</span>
        <span class="s1">ClassLoader acl </span><span class="s3">= </span><span class="s2">this</span><span class="s3">;</span>
        <span class="s2">do </span><span class="s3">{</span>
            <span class="s1">acl </span><span class="s3">= </span><span class="s1">acl</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">;</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">cl </span><span class="s3">== </span><span class="s1">acl</span><span class="s3">) {</span>
                <span class="s2">return true</span><span class="s3">;</span>
            <span class="s3">}</span>
        <span class="s3">} </span><span class="s2">while </span><span class="s3">(</span><span class="s1">acl </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">);</span>
        <span class="s2">return false</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// Tests if class loader access requires &quot;getClassLoader&quot; permission</span>
    <span class="s0">// check.  A class loader 'from' can access class loader 'to' if</span>
    <span class="s0">// class loader 'from' is same as class loader 'to' or an ancestor</span>
    <span class="s0">// of 'to'.  The class loader in a system domain can access</span>
    <span class="s0">// any class loader.</span>
    <span class="s2">private static boolean </span><span class="s1">needsClassLoaderPermissionCheck</span><span class="s3">(</span><span class="s1">ClassLoader from</span><span class="s3">,</span>
                                                           <span class="s1">ClassLoader to</span><span class="s3">)</span>
    <span class="s3">{</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">from </span><span class="s3">== </span><span class="s1">to</span><span class="s3">)</span>
            <span class="s2">return false</span><span class="s3">;</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">from </span><span class="s3">== </span><span class="s2">null</span><span class="s3">)</span>
            <span class="s2">return false</span><span class="s3">;</span>

        <span class="s2">return </span><span class="s3">!</span><span class="s1">to</span><span class="s3">.</span><span class="s1">isAncestor</span><span class="s3">(</span><span class="s1">from</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s0">// Returns the class's class loader, or null if none.</span>
    <span class="s2">static </span><span class="s1">ClassLoader getClassLoader</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">caller</span><span class="s3">) {</span>
        <span class="s0">// This can be null if the VM is requesting it</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">caller </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">return null</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s0">// Circumvent security check since this is package-private</span>
        <span class="s2">return </span><span class="s1">caller</span><span class="s3">.</span><span class="s1">getClassLoader0</span><span class="s3">();</span>
    <span class="s3">}</span>

    <span class="s0">/* 
     * Checks RuntimePermission(&quot;getClassLoader&quot;) permission 
     * if caller's class loader is not null and caller's class loader 
     * is not the same as or an ancestor of the given cl argument. 
     */</span>
    <span class="s2">static void </span><span class="s1">checkClassLoaderPermission</span><span class="s3">(</span><span class="s1">ClassLoader cl</span><span class="s3">, </span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">caller</span><span class="s3">) {</span>
        <span class="s1">@SuppressWarnings</span><span class="s3">(</span><span class="s8">&quot;removal&quot;</span><span class="s3">)</span>
        <span class="s1">SecurityManager sm </span><span class="s3">= </span><span class="s1">System</span><span class="s3">.</span><span class="s1">getSecurityManager</span><span class="s3">();</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">sm </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s0">// caller can be null if the VM is requesting it</span>
            <span class="s1">ClassLoader ccl </span><span class="s3">= </span><span class="s1">getClassLoader</span><span class="s3">(</span><span class="s1">caller</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">needsClassLoaderPermissionCheck</span><span class="s3">(</span><span class="s1">ccl</span><span class="s3">, </span><span class="s1">cl</span><span class="s3">)) {</span>
                <span class="s1">sm</span><span class="s3">.</span><span class="s1">checkPermission</span><span class="s3">(</span><span class="s1">SecurityConstants</span><span class="s3">.</span><span class="s1">GET_CLASSLOADER_PERMISSION</span><span class="s3">);</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s0">// The system class loader</span>
    <span class="s0">// @GuardedBy(&quot;ClassLoader.class&quot;)</span>
    <span class="s2">private static volatile </span><span class="s1">ClassLoader scl</span><span class="s3">;</span>

    <span class="s0">// -- Package --</span>

    <span class="s4">/**</span>
     <span class="s4">* Define a Package of the given Class object.</span>
     <span class="s4">*</span>
     <span class="s4">* If the given class represents an array type, a primitive type or void,</span>
     <span class="s4">* this method returns {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* This method does not throw IllegalArgumentException.</span>
     <span class="s4">*/</span>
    <span class="s1">Package definePackage</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">c</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">isPrimitive</span><span class="s3">() || </span><span class="s1">c</span><span class="s3">.</span><span class="s1">isArray</span><span class="s3">()) {</span>
            <span class="s2">return null</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s2">return </span><span class="s1">definePackage</span><span class="s3">(</span><span class="s1">c</span><span class="s3">.</span><span class="s1">getPackageName</span><span class="s3">(), </span><span class="s1">c</span><span class="s3">.</span><span class="s1">getModule</span><span class="s3">());</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Defines a Package of the given name and module</span>
     <span class="s4">*</span>
     <span class="s4">* This method does not throw IllegalArgumentException.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">name package name</span>
     <span class="s4">* </span><span class="s5">@param </span><span class="s4">m    module</span>
     <span class="s4">*/</span>
    <span class="s1">Package definePackage</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s1">Module m</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">name</span><span class="s3">.</span><span class="s1">isEmpty</span><span class="s3">() &amp;&amp; </span><span class="s1">m</span><span class="s3">.</span><span class="s1">isNamed</span><span class="s3">()) {</span>
            <span class="s2">throw new </span><span class="s1">InternalError</span><span class="s3">(</span><span class="s8">&quot;unnamed package in  &quot; </span><span class="s3">+ </span><span class="s1">m</span><span class="s3">);</span>
        <span class="s3">}</span>

        <span class="s0">// check if Package object is already defined</span>
        <span class="s1">NamedPackage pkg </span><span class="s3">= </span><span class="s1">packages</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">pkg </span><span class="s2">instanceof </span><span class="s1">Package</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s1">Package</span><span class="s3">)</span><span class="s1">pkg</span><span class="s3">;</span>

        <span class="s2">return </span><span class="s3">(</span><span class="s1">Package</span><span class="s3">)</span><span class="s1">packages</span><span class="s3">.</span><span class="s1">compute</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, (</span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">) </span><span class="s1">-&gt; toPackage</span><span class="s3">(</span><span class="s1">n</span><span class="s3">, </span><span class="s1">p</span><span class="s3">, </span><span class="s1">m</span><span class="s3">));</span>
    <span class="s3">}</span>

    <span class="s0">/* 
     * Returns a Package object for the named package 
     */</span>
    <span class="s2">private </span><span class="s1">Package toPackage</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s1">NamedPackage p</span><span class="s3">, </span><span class="s1">Module m</span><span class="s3">) {</span>
        <span class="s0">// define Package object if the named package is not yet defined</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">p </span><span class="s3">== </span><span class="s2">null</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s1">NamedPackage</span><span class="s3">.</span><span class="s1">toPackage</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">m</span><span class="s3">);</span>

        <span class="s0">// otherwise, replace the NamedPackage object with Package object</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">p </span><span class="s2">instanceof </span><span class="s1">Package</span><span class="s3">)</span>
            <span class="s2">return </span><span class="s3">(</span><span class="s1">Package</span><span class="s3">)</span><span class="s1">p</span><span class="s3">;</span>

        <span class="s2">return </span><span class="s1">NamedPackage</span><span class="s3">.</span><span class="s1">toPackage</span><span class="s3">(</span><span class="s1">p</span><span class="s3">.</span><span class="s1">packageName</span><span class="s3">(), </span><span class="s1">p</span><span class="s3">.</span><span class="s1">module</span><span class="s3">());</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Defines a package by </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">name</span><span class="s6">&lt;/a&gt; </span><span class="s4">in this {</span><span class="s5">@code </span><span class="s4">ClassLoader}.</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt;</span>
     <span class="s4">* </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">Package names</span><span class="s6">&lt;/a&gt; </span><span class="s4">must be unique within a class loader and</span>
     <span class="s4">* cannot be redefined or changed once created.</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt;</span>
     <span class="s4">* If a class loader wishes to define a package with specific properties,</span>
     <span class="s4">* such as version information, then the class loader should call this</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">definePackage} method before calling {</span><span class="s5">@code </span><span class="s4">defineClass}.</span>
     <span class="s4">* Otherwise, the</span>
     <span class="s4">* {</span><span class="s5">@link </span><span class="s4">#defineClass(String, byte[], int, int, ProtectionDomain) defineClass}</span>
     <span class="s4">* method will define a package in this class loader corresponding to the package</span>
     <span class="s4">* of the newly defined class; the properties of this defined package are</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Package}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote</span>
     <span class="s4">* A class loader that wishes to define a package for classes in a JAR</span>
     <span class="s4">* typically uses the specification and implementation titles, versions, and</span>
     <span class="s4">* vendors from the JAR's manifest. If the package is specified as</span>
     <span class="s4">* {</span><span class="s5">@linkplain </span><span class="s4">java.util.jar.Attributes.Name#SEALED sealed} in the JAR's manifest,</span>
     <span class="s4">* the {</span><span class="s5">@code </span><span class="s4">URL} of the JAR file is typically used as the {</span><span class="s5">@code </span><span class="s4">sealBase}.</span>
     <span class="s4">* If classes of package {</span><span class="s5">@code </span><span class="s4">'p'} defined by this class loader</span>
     <span class="s4">* are loaded from multiple JARs, the {</span><span class="s5">@code </span><span class="s4">Package} object may contain</span>
     <span class="s4">* different information depending on the first class of package {</span><span class="s5">@code </span><span class="s4">'p'}</span>
     <span class="s4">* defined and which JAR's manifest is read first to explicitly define</span>
     <span class="s4">* package {</span><span class="s5">@code </span><span class="s4">'p'}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">It is strongly recommended that a class loader does not call this</span>
     <span class="s4">* method to explicitly define packages in </span><span class="s6">&lt;em&gt;</span><span class="s4">named modules</span><span class="s6">&lt;/em&gt;</span><span class="s4">; instead,</span>
     <span class="s4">* the package will be automatically defined when a class is {</span><span class="s5">@linkplain</span>
     <span class="s4">* #defineClass(String, byte[], int, int, ProtectionDomain) being defined}.</span>
     <span class="s4">* If it is desirable to define {</span><span class="s5">@code </span><span class="s4">Package} explicitly, it should ensure</span>
     <span class="s4">* that all packages in a named module are defined with the properties</span>
     <span class="s4">* specified by {</span><span class="s5">@link </span><span class="s4">Package}.  Otherwise, some {</span><span class="s5">@code </span><span class="s4">Package} objects</span>
     <span class="s4">* in a named module may be for example sealed with different seal base.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">package name</span><span class="s6">&lt;/a&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">specTitle</span>
     <span class="s4">*         The specification title</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">specVersion</span>
     <span class="s4">*         The specification version</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">specVendor</span>
     <span class="s4">*         The specification vendor</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">implTitle</span>
     <span class="s4">*         The implementation title</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">implVersion</span>
     <span class="s4">*         The implementation version</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">implVendor</span>
     <span class="s4">*         The implementation vendor</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">sealBase</span>
     <span class="s4">*         If not {</span><span class="s5">@code </span><span class="s4">null}, then this package is sealed with</span>
     <span class="s4">*         respect to the given code source {</span><span class="s5">@link </span><span class="s4">java.net.URL URL}</span>
     <span class="s4">*         object.  Otherwise, the package is not sealed.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The newly defined {</span><span class="s5">@code </span><span class="s4">Package} object</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NullPointerException</span>
     <span class="s4">*          if {</span><span class="s5">@code </span><span class="s4">name} is {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">IllegalArgumentException</span>
     <span class="s4">*          if a package of the given {</span><span class="s5">@code </span><span class="s4">name} is already</span>
     <span class="s4">*          defined by this class loader</span>
     <span class="s4">*</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@jvms </span><span class="s4">5.3 Creation and Loading</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s6">&lt;a href=&quot;</span><span class="s4">{</span><span class="s5">@docRoot</span><span class="s4">}/../specs/jar/jar.html#package-sealing&quot;&gt;</span>
     <span class="s4">*      The JAR File Specification: Package Sealing</span><span class="s6">&lt;/a&gt;</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">Package definePackage</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s1">String specTitle</span><span class="s3">,</span>
                                    <span class="s1">String specVersion</span><span class="s3">, </span><span class="s1">String specVendor</span><span class="s3">,</span>
                                    <span class="s1">String implTitle</span><span class="s3">, </span><span class="s1">String implVersion</span><span class="s3">,</span>
                                    <span class="s1">String implVendor</span><span class="s3">, </span><span class="s1">URL sealBase</span><span class="s3">)</span>
    <span class="s3">{</span>
        <span class="s1">Objects</span><span class="s3">.</span><span class="s1">requireNonNull</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>

        <span class="s0">// definePackage is not final and may be overridden by custom class loader</span>
        <span class="s1">Package p </span><span class="s3">= </span><span class="s2">new </span><span class="s1">Package</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">specTitle</span><span class="s3">, </span><span class="s1">specVersion</span><span class="s3">, </span><span class="s1">specVendor</span><span class="s3">,</span>
                                <span class="s1">implTitle</span><span class="s3">, </span><span class="s1">implVersion</span><span class="s3">, </span><span class="s1">implVendor</span><span class="s3">,</span>
                                <span class="s1">sealBase</span><span class="s3">, </span><span class="s2">this</span><span class="s3">);</span>

        <span class="s2">if </span><span class="s3">(</span><span class="s1">packages</span><span class="s3">.</span><span class="s1">putIfAbsent</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">p</span><span class="s3">) != </span><span class="s2">null</span><span class="s3">)</span>
            <span class="s2">throw new </span><span class="s1">IllegalArgumentException</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>

        <span class="s2">return </span><span class="s1">p</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns a {</span><span class="s5">@code </span><span class="s4">Package} of the given </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">name</span><span class="s6">&lt;/a&gt; </span><span class="s4">that</span>
     <span class="s4">* has been defined by this class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">package name</span><span class="s6">&lt;/a&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">Package} of the given name that has been defined</span>
     <span class="s4">*         by this class loader, or {</span><span class="s5">@code </span><span class="s4">null} if not found</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NullPointerException</span>
     <span class="s4">*          if {</span><span class="s5">@code </span><span class="s4">name} is {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@jvms </span><span class="s4">5.3 Creation and Loading</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public final </span><span class="s1">Package getDefinedPackage</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s1">Objects</span><span class="s3">.</span><span class="s1">requireNonNull</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s8">&quot;name cannot be null&quot;</span><span class="s3">);</span>

        <span class="s1">NamedPackage p </span><span class="s3">= </span><span class="s1">packages</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">p </span><span class="s3">== </span><span class="s2">null</span><span class="s3">)</span>
            <span class="s2">return null</span><span class="s3">;</span>

        <span class="s2">return </span><span class="s1">definePackage</span><span class="s3">(</span><span class="s1">name</span><span class="s3">, </span><span class="s1">p</span><span class="s3">.</span><span class="s1">module</span><span class="s3">());</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns all of the {</span><span class="s5">@code </span><span class="s4">Package}s that have been defined by</span>
     <span class="s4">* this class loader.  The returned array has no duplicated {</span><span class="s5">@code </span><span class="s4">Package}s</span>
     <span class="s4">* of the same name.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">This method returns an array rather than a {</span><span class="s5">@code </span><span class="s4">Set} or {</span><span class="s5">@code </span><span class="s4">Stream}</span>
     <span class="s4">*          for consistency with the existing {</span><span class="s5">@link </span><span class="s4">#getPackages} method.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">The array of {</span><span class="s5">@code </span><span class="s4">Package} objects that have been defined by</span>
     <span class="s4">*         this class loader; or a zero length array if no package has been</span>
     <span class="s4">*         defined by this class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@jvms </span><span class="s4">5.3 Creation and Loading</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">public final </span><span class="s1">Package</span><span class="s3">[] </span><span class="s1">getDefinedPackages</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">packages</span><span class="s3">().</span><span class="s1">toArray</span><span class="s3">(</span><span class="s1">Package</span><span class="s3">[]</span><span class="s1">::</span><span class="s2">new</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Finds a package by </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">name</span><span class="s6">&lt;/a&gt; </span><span class="s4">in this class loader and its ancestors.</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt;</span>
     <span class="s4">* If this class loader defines a {</span><span class="s5">@code </span><span class="s4">Package} of the given name,</span>
     <span class="s4">* the {</span><span class="s5">@code </span><span class="s4">Package} is returned. Otherwise, the ancestors of</span>
     <span class="s4">* this class loader are searched recursively (parent by parent)</span>
     <span class="s4">* for a {</span><span class="s5">@code </span><span class="s4">Package} of the given name.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">The {</span><span class="s5">@link </span><span class="s4">#getPlatformClassLoader() platform class loader}</span>
     <span class="s4">* may delegate to the application class loader but the application class</span>
     <span class="s4">* loader is not its ancestor.  When invoked on the platform class loader,</span>
     <span class="s4">* this method  will not find packages defined to the application</span>
     <span class="s4">* class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">name</span>
     <span class="s4">*         The </span><span class="s6">&lt;a href=&quot;#binary-name&quot;&gt;</span><span class="s4">package name</span><span class="s6">&lt;/a&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return </span><span class="s4">The {</span><span class="s5">@code </span><span class="s4">Package} of the given name that has been defined by</span>
     <span class="s4">*         this class loader or its ancestors, or {</span><span class="s5">@code </span><span class="s4">null} if not found.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@throws  </span><span class="s4">NullPointerException</span>
     <span class="s4">*          if {</span><span class="s5">@code </span><span class="s4">name} is {</span><span class="s5">@code </span><span class="s4">null}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@deprecated</span>
     <span class="s4">* If multiple class loaders delegate to each other and define classes</span>
     <span class="s4">* with the same package name, and one such loader relies on the lookup</span>
     <span class="s4">* behavior of {</span><span class="s5">@code </span><span class="s4">getPackage} to return a {</span><span class="s5">@code </span><span class="s4">Package} from</span>
     <span class="s4">* a parent loader, then the properties exposed by the {</span><span class="s5">@code </span><span class="s4">Package}</span>
     <span class="s4">* may not be as expected in the rest of the program.</span>
     <span class="s4">* For example, the {</span><span class="s5">@code </span><span class="s4">Package} will only expose annotations from the</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">package-info.class} file defined by the parent loader, even if</span>
     <span class="s4">* annotations exist in a {</span><span class="s5">@code </span><span class="s4">package-info.class} file defined by</span>
     <span class="s4">* a child loader.  A more robust approach is to use the</span>
     <span class="s4">* {</span><span class="s5">@link </span><span class="s4">ClassLoader#getDefinedPackage} method which returns</span>
     <span class="s4">* a {</span><span class="s5">@code </span><span class="s4">Package} for the specified class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">ClassLoader#getDefinedPackage(String)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s1">@Deprecated</span><span class="s3">(</span><span class="s1">since</span><span class="s3">=</span><span class="s8">&quot;9&quot;</span><span class="s3">)</span>
    <span class="s2">protected </span><span class="s1">Package getPackage</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s1">Package pkg </span><span class="s3">= </span><span class="s1">getDefinedPackage</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">pkg </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">parent </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
                <span class="s1">pkg </span><span class="s3">= </span><span class="s1">parent</span><span class="s3">.</span><span class="s1">getPackage</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
            <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
                <span class="s1">pkg </span><span class="s3">= </span><span class="s1">BootLoader</span><span class="s3">.</span><span class="s1">getDefinedPackage</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">pkg</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns all of the {</span><span class="s5">@code </span><span class="s4">Package}s that have been defined by</span>
     <span class="s4">* this class loader and its ancestors.  The returned array may contain</span>
     <span class="s4">* more than one {</span><span class="s5">@code </span><span class="s4">Package} object of the same package name, each</span>
     <span class="s4">* defined by a different class loader in the class loader hierarchy.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@apiNote </span><span class="s4">The {</span><span class="s5">@link </span><span class="s4">#getPlatformClassLoader() platform class loader}</span>
     <span class="s4">* may delegate to the application class loader. In other words,</span>
     <span class="s4">* packages in modules defined to the application class loader may be</span>
     <span class="s4">* visible to the platform class loader.  On the other hand,</span>
     <span class="s4">* the application class loader is not its ancestor and hence</span>
     <span class="s4">* when invoked on the platform class loader, this method will not</span>
     <span class="s4">* return any packages defined to the application class loader.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The array of {</span><span class="s5">@code </span><span class="s4">Package} objects that have been defined by</span>
     <span class="s4">*          this class loader and its ancestors</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see </span><span class="s4">ClassLoader#getDefinedPackages()</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">* </span><span class="s5">@revised </span><span class="s4">9</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">Package</span><span class="s3">[] </span><span class="s1">getPackages</span><span class="s3">() {</span>
        <span class="s1">Stream</span><span class="s3">&lt;</span><span class="s1">Package</span><span class="s3">&gt; </span><span class="s1">pkgs </span><span class="s3">= </span><span class="s1">packages</span><span class="s3">();</span>
        <span class="s1">ClassLoader ld </span><span class="s3">= </span><span class="s1">parent</span><span class="s3">;</span>
        <span class="s2">while </span><span class="s3">(</span><span class="s1">ld </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">pkgs </span><span class="s3">= </span><span class="s1">Stream</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">(</span><span class="s1">ld</span><span class="s3">.</span><span class="s1">packages</span><span class="s3">(), </span><span class="s1">pkgs</span><span class="s3">);</span>
            <span class="s1">ld </span><span class="s3">= </span><span class="s1">ld</span><span class="s3">.</span><span class="s1">parent</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">Stream</span><span class="s3">.</span><span class="s1">concat</span><span class="s3">(</span><span class="s1">BootLoader</span><span class="s3">.</span><span class="s1">packages</span><span class="s3">(), </span><span class="s1">pkgs</span><span class="s3">)</span>
                     <span class="s3">.</span><span class="s1">toArray</span><span class="s3">(</span><span class="s1">Package</span><span class="s3">[]</span><span class="s1">::</span><span class="s2">new</span><span class="s3">);</span>
    <span class="s3">}</span>



    <span class="s0">// package-private</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns a stream of Packages defined in this class loader</span>
     <span class="s4">*/</span>
    <span class="s1">Stream</span><span class="s3">&lt;</span><span class="s1">Package</span><span class="s3">&gt; </span><span class="s1">packages</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">packages</span><span class="s3">.</span><span class="s1">values</span><span class="s3">().</span><span class="s1">stream</span><span class="s3">()</span>
                       <span class="s3">.</span><span class="s1">map</span><span class="s3">(</span><span class="s1">p -&gt; definePackage</span><span class="s3">(</span><span class="s1">p</span><span class="s3">.</span><span class="s1">packageName</span><span class="s3">(), </span><span class="s1">p</span><span class="s3">.</span><span class="s1">module</span><span class="s3">()));</span>
    <span class="s3">}</span>

    <span class="s0">// -- Native library access --</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the absolute path name of a native library.  The VM invokes this</span>
     <span class="s4">* method to locate the native libraries that belong to classes loaded with</span>
     <span class="s4">* this class loader. If this method returns {</span><span class="s5">@code </span><span class="s4">null}, the VM</span>
     <span class="s4">* searches the library along the path specified as the</span>
     <span class="s4">* &quot;{</span><span class="s5">@code </span><span class="s4">java.library.path}&quot; property.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">libname</span>
     <span class="s4">*         The library name</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The absolute path of the native library</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">System#loadLibrary(String)</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">System#mapLibraryName(String)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.2</span>
     <span class="s4">*/</span>
    <span class="s2">protected </span><span class="s1">String findLibrary</span><span class="s3">(</span><span class="s1">String libname</span><span class="s3">) {</span>
        <span class="s2">return null</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">private final </span><span class="s1">NativeLibraries libraries </span><span class="s3">= </span><span class="s1">NativeLibraries</span><span class="s3">.</span><span class="s1">newInstance</span><span class="s3">(</span><span class="s2">this</span><span class="s3">);</span>

    <span class="s0">// Invoked in the java.lang.Runtime class to implement load and loadLibrary.</span>
    <span class="s2">static </span><span class="s1">NativeLibrary loadLibrary</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">fromClass</span><span class="s3">, </span><span class="s1">File file</span><span class="s3">) {</span>
        <span class="s1">ClassLoader loader </span><span class="s3">= (</span><span class="s1">fromClass </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) ? </span><span class="s2">null </span><span class="s3">: </span><span class="s1">fromClass</span><span class="s3">.</span><span class="s1">getClassLoader</span><span class="s3">();</span>
        <span class="s1">NativeLibraries libs </span><span class="s3">= </span><span class="s1">loader </span><span class="s3">!= </span><span class="s2">null </span><span class="s3">? </span><span class="s1">loader</span><span class="s3">.</span><span class="s1">libraries </span><span class="s3">: </span><span class="s1">BootLoader</span><span class="s3">.</span><span class="s1">getNativeLibraries</span><span class="s3">();</span>
        <span class="s1">NativeLibrary nl </span><span class="s3">= </span><span class="s1">libs</span><span class="s3">.</span><span class="s1">loadLibrary</span><span class="s3">(</span><span class="s1">fromClass</span><span class="s3">, </span><span class="s1">file</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">nl </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">return </span><span class="s1">nl</span><span class="s3">;</span>
        <span class="s3">}</span>
        <span class="s2">throw new </span><span class="s1">UnsatisfiedLinkError</span><span class="s3">(</span><span class="s8">&quot;Can't load library: &quot; </span><span class="s3">+ </span><span class="s1">file</span><span class="s3">);</span>
    <span class="s3">}</span>
    <span class="s2">static </span><span class="s1">NativeLibrary loadLibrary</span><span class="s3">(</span><span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">fromClass</span><span class="s3">, </span><span class="s1">String name</span><span class="s3">) {</span>
        <span class="s1">ClassLoader loader </span><span class="s3">= (</span><span class="s1">fromClass </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) ? </span><span class="s2">null </span><span class="s3">: </span><span class="s1">fromClass</span><span class="s3">.</span><span class="s1">getClassLoader</span><span class="s3">();</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">loader </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">NativeLibrary nl </span><span class="s3">= </span><span class="s1">BootLoader</span><span class="s3">.</span><span class="s1">getNativeLibraries</span><span class="s3">().</span><span class="s1">loadLibrary</span><span class="s3">(</span><span class="s1">fromClass</span><span class="s3">, </span><span class="s1">name</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">nl </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
                <span class="s2">return </span><span class="s1">nl</span><span class="s3">;</span>
            <span class="s3">}</span>
            <span class="s2">throw new </span><span class="s1">UnsatisfiedLinkError</span><span class="s3">(</span><span class="s8">&quot;no &quot; </span><span class="s3">+ </span><span class="s1">name </span><span class="s3">+</span>
                    <span class="s8">&quot; in system library path: &quot; </span><span class="s3">+ </span><span class="s1">StaticProperty</span><span class="s3">.</span><span class="s1">sunBootLibraryPath</span><span class="s3">());</span>
        <span class="s3">}</span>

        <span class="s1">NativeLibraries libs </span><span class="s3">= </span><span class="s1">loader</span><span class="s3">.</span><span class="s1">libraries</span><span class="s3">;</span>
        <span class="s0">// First load from the file returned from ClassLoader::findLibrary, if found.</span>
        <span class="s1">String libfilename </span><span class="s3">= </span><span class="s1">loader</span><span class="s3">.</span><span class="s1">findLibrary</span><span class="s3">(</span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">libfilename </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">File libfile </span><span class="s3">= </span><span class="s2">new </span><span class="s1">File</span><span class="s3">(</span><span class="s1">libfilename</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(!</span><span class="s1">libfile</span><span class="s3">.</span><span class="s1">isAbsolute</span><span class="s3">()) {</span>
                <span class="s2">throw new </span><span class="s1">UnsatisfiedLinkError</span><span class="s3">(</span>
                        <span class="s8">&quot;ClassLoader.findLibrary failed to return an absolute path: &quot; </span><span class="s3">+ </span><span class="s1">libfilename</span><span class="s3">);</span>
            <span class="s3">}</span>
            <span class="s1">NativeLibrary nl </span><span class="s3">= </span><span class="s1">libs</span><span class="s3">.</span><span class="s1">loadLibrary</span><span class="s3">(</span><span class="s1">fromClass</span><span class="s3">, </span><span class="s1">libfile</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">nl </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
                <span class="s2">return </span><span class="s1">nl</span><span class="s3">;</span>
            <span class="s3">}</span>
            <span class="s2">throw new </span><span class="s1">UnsatisfiedLinkError</span><span class="s3">(</span><span class="s8">&quot;Can't load &quot; </span><span class="s3">+ </span><span class="s1">libfilename</span><span class="s3">);</span>
        <span class="s3">}</span>
        <span class="s0">// Then load from system library path and java library path</span>
        <span class="s1">NativeLibrary nl </span><span class="s3">= </span><span class="s1">libs</span><span class="s3">.</span><span class="s1">loadLibrary</span><span class="s3">(</span><span class="s1">fromClass</span><span class="s3">, </span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">nl </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">return </span><span class="s1">nl</span><span class="s3">;</span>
        <span class="s3">}</span>

        <span class="s0">// Oops, it failed</span>
        <span class="s2">throw new </span><span class="s1">UnsatisfiedLinkError</span><span class="s3">(</span><span class="s8">&quot;no &quot; </span><span class="s3">+ </span><span class="s1">name </span><span class="s3">+</span>
                <span class="s8">&quot; in java.library.path: &quot; </span><span class="s3">+ </span><span class="s1">StaticProperty</span><span class="s3">.</span><span class="s1">javaLibraryPath</span><span class="s3">());</span>
    <span class="s3">}</span>

    <span class="s0">/* 
     * Invoked in the VM class linking code. 
     */</span>
    <span class="s2">static long </span><span class="s1">findNative</span><span class="s3">(</span><span class="s1">ClassLoader loader</span><span class="s3">, </span><span class="s1">String entryName</span><span class="s3">) {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">loader </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s2">return </span><span class="s1">BootLoader</span><span class="s3">.</span><span class="s1">getNativeLibraries</span><span class="s3">().</span><span class="s1">find</span><span class="s3">(</span><span class="s1">entryName</span><span class="s3">);</span>
        <span class="s3">} </span><span class="s2">else </span><span class="s3">{</span>
            <span class="s2">return </span><span class="s1">loader</span><span class="s3">.</span><span class="s1">libraries</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s1">entryName</span><span class="s3">);</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s0">// -- Assertion management --</span>

    <span class="s2">final </span><span class="s1">Object assertionLock</span><span class="s3">;</span>

    <span class="s0">// The default toggle for assertion checking.</span>
    <span class="s0">// @GuardedBy(&quot;assertionLock&quot;)</span>
    <span class="s2">private boolean </span><span class="s1">defaultAssertionStatus </span><span class="s3">= </span><span class="s2">false</span><span class="s3">;</span>

    <span class="s0">// Maps String packageName to Boolean package default assertion status Note</span>
    <span class="s0">// that the default package is placed under a null map key.  If this field</span>
    <span class="s0">// is null then we are delegating assertion status queries to the VM, i.e.,</span>
    <span class="s0">// none of this ClassLoader's assertion status modification methods have</span>
    <span class="s0">// been invoked.</span>
    <span class="s0">// @GuardedBy(&quot;assertionLock&quot;)</span>
    <span class="s2">private </span><span class="s1">Map</span><span class="s3">&lt;</span><span class="s1">String</span><span class="s3">, </span><span class="s1">Boolean</span><span class="s3">&gt; </span><span class="s1">packageAssertionStatus </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>

    <span class="s0">// Maps String fullyQualifiedClassName to Boolean assertionStatus If this</span>
    <span class="s0">// field is null then we are delegating assertion status queries to the VM,</span>
    <span class="s0">// i.e., none of this ClassLoader's assertion status modification methods</span>
    <span class="s0">// have been invoked.</span>
    <span class="s0">// @GuardedBy(&quot;assertionLock&quot;)</span>
    <span class="s1">Map</span><span class="s3">&lt;</span><span class="s1">String</span><span class="s3">, </span><span class="s1">Boolean</span><span class="s3">&gt; </span><span class="s1">classAssertionStatus </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the default assertion status for this class loader.  This setting</span>
     <span class="s4">* determines whether classes loaded by this class loader and initialized</span>
     <span class="s4">* in the future will have assertions enabled or disabled by default.</span>
     <span class="s4">* This setting may be overridden on a per-package or per-class basis by</span>
     <span class="s4">* invoking {</span><span class="s5">@link </span><span class="s4">#setPackageAssertionStatus(String, boolean)} or {</span><span class="s5">@link</span>
     <span class="s4">* #setClassAssertionStatus(String, boolean)}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">enabled</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">true} if classes loaded by this class loader will</span>
     <span class="s4">*         henceforth have assertions enabled by default, {</span><span class="s5">@code </span><span class="s4">false}</span>
     <span class="s4">*         if they will have assertions disabled by default.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.4</span>
     <span class="s4">*/</span>
    <span class="s2">public void </span><span class="s1">setDefaultAssertionStatus</span><span class="s3">(</span><span class="s2">boolean </span><span class="s1">enabled</span><span class="s3">) {</span>
        <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">assertionLock</span><span class="s3">) {</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">classAssertionStatus </span><span class="s3">== </span><span class="s2">null</span><span class="s3">)</span>
                <span class="s1">initializeJavaAssertionMaps</span><span class="s3">();</span>

            <span class="s1">defaultAssertionStatus </span><span class="s3">= </span><span class="s1">enabled</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the package default assertion status for the named package.  The</span>
     <span class="s4">* package default assertion status determines the assertion status for</span>
     <span class="s4">* classes initialized in the future that belong to the named package or</span>
     <span class="s4">* any of its &quot;subpackages&quot;.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">A subpackage of a package named p is any package whose name begins</span>
     <span class="s4">* with &quot;{</span><span class="s5">@code </span><span class="s4">p.}&quot;.  For example, {</span><span class="s5">@code </span><span class="s4">javax.swing.text} is a</span>
     <span class="s4">* subpackage of {</span><span class="s5">@code </span><span class="s4">javax.swing}, and both {</span><span class="s5">@code </span><span class="s4">java.util} and</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">java.lang.reflect} are subpackages of {</span><span class="s5">@code </span><span class="s4">java}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">In the event that multiple package defaults apply to a given class,</span>
     <span class="s4">* the package default pertaining to the most specific package takes</span>
     <span class="s4">* precedence over the others.  For example, if {</span><span class="s5">@code </span><span class="s4">javax.lang} and</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">javax.lang.reflect} both have package defaults associated with</span>
     <span class="s4">* them, the latter package default applies to classes in</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">javax.lang.reflect}.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">Package defaults take precedence over the class loader's default</span>
     <span class="s4">* assertion status, and may be overridden on a per-class basis by invoking</span>
     <span class="s4">* {</span><span class="s5">@link </span><span class="s4">#setClassAssertionStatus(String, boolean)}.  </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">packageName</span>
     <span class="s4">*         The name of the package whose package default assertion status</span>
     <span class="s4">*         is to be set. A {</span><span class="s5">@code </span><span class="s4">null} value indicates the unnamed</span>
     <span class="s4">*         package that is &quot;current&quot;</span>
     <span class="s4">*         (see section {</span><span class="s5">@jls </span><span class="s4">7.4.2} of</span>
     <span class="s4">*         </span><span class="s6">&lt;cite&gt;</span><span class="s4">The Java Language Specification</span><span class="s6">&lt;/cite&gt;</span><span class="s4">.)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">enabled</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">true} if classes loaded by this classloader and</span>
     <span class="s4">*         belonging to the named package or any of its subpackages will</span>
     <span class="s4">*         have assertions enabled by default, {</span><span class="s5">@code </span><span class="s4">false} if they will</span>
     <span class="s4">*         have assertions disabled by default.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.4</span>
     <span class="s4">*/</span>
    <span class="s2">public void </span><span class="s1">setPackageAssertionStatus</span><span class="s3">(</span><span class="s1">String packageName</span><span class="s3">,</span>
                                          <span class="s2">boolean </span><span class="s1">enabled</span><span class="s3">) {</span>
        <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">assertionLock</span><span class="s3">) {</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">packageAssertionStatus </span><span class="s3">== </span><span class="s2">null</span><span class="s3">)</span>
                <span class="s1">initializeJavaAssertionMaps</span><span class="s3">();</span>

            <span class="s1">packageAssertionStatus</span><span class="s3">.</span><span class="s1">put</span><span class="s3">(</span><span class="s1">packageName</span><span class="s3">, </span><span class="s1">enabled</span><span class="s3">);</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the desired assertion status for the named top-level class in this</span>
     <span class="s4">* class loader and any nested classes contained therein.  This setting</span>
     <span class="s4">* takes precedence over the class loader's default assertion status, and</span>
     <span class="s4">* over any applicable per-package default.  This method has no effect if</span>
     <span class="s4">* the named class has already been initialized.  (Once a class is</span>
     <span class="s4">* initialized, its assertion status cannot change.)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s6">&lt;p&gt; </span><span class="s4">If the named class is not a top-level class, this invocation will</span>
     <span class="s4">* have no effect on the actual assertion status of any class. </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">className</span>
     <span class="s4">*         The fully qualified class name of the top-level class whose</span>
     <span class="s4">*         assertion status is to be set.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">enabled</span>
     <span class="s4">*         {</span><span class="s5">@code </span><span class="s4">true} if the named class is to have assertions</span>
     <span class="s4">*         enabled when (and if) it is initialized, {</span><span class="s5">@code </span><span class="s4">false} if the</span>
     <span class="s4">*         class is to have assertions disabled.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.4</span>
     <span class="s4">*/</span>
    <span class="s2">public void </span><span class="s1">setClassAssertionStatus</span><span class="s3">(</span><span class="s1">String className</span><span class="s3">, </span><span class="s2">boolean </span><span class="s1">enabled</span><span class="s3">) {</span>
        <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">assertionLock</span><span class="s3">) {</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">classAssertionStatus </span><span class="s3">== </span><span class="s2">null</span><span class="s3">)</span>
                <span class="s1">initializeJavaAssertionMaps</span><span class="s3">();</span>

            <span class="s1">classAssertionStatus</span><span class="s3">.</span><span class="s1">put</span><span class="s3">(</span><span class="s1">className</span><span class="s3">, </span><span class="s1">enabled</span><span class="s3">);</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Sets the default assertion status for this class loader to</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">false} and discards any package defaults or class assertion</span>
     <span class="s4">* status settings associated with the class loader.  This method is</span>
     <span class="s4">* provided so that class loaders can be made to ignore any command line or</span>
     <span class="s4">* persistent assertion status settings and &quot;start with a clean slate.&quot;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.4</span>
     <span class="s4">*/</span>
    <span class="s2">public void </span><span class="s1">clearAssertionStatus</span><span class="s3">() {</span>
        <span class="s0">/* 
         * Whether or not &quot;Java assertion maps&quot; are initialized, set 
         * them to empty maps, effectively ignoring any present settings. 
         */</span>
        <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">assertionLock</span><span class="s3">) {</span>
            <span class="s1">classAssertionStatus </span><span class="s3">= </span><span class="s2">new </span><span class="s1">HashMap</span><span class="s3">&lt;&gt;();</span>
            <span class="s1">packageAssertionStatus </span><span class="s3">= </span><span class="s2">new </span><span class="s1">HashMap</span><span class="s3">&lt;&gt;();</span>
            <span class="s1">defaultAssertionStatus </span><span class="s3">= </span><span class="s2">false</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the assertion status that would be assigned to the specified</span>
     <span class="s4">* class if it were to be initialized at the time this method is invoked.</span>
     <span class="s4">* If the named class has had its assertion status set, the most recent</span>
     <span class="s4">* setting will be returned; otherwise, if any package default assertion</span>
     <span class="s4">* status pertains to this class, the most recent setting for the most</span>
     <span class="s4">* specific pertinent package default assertion status is returned;</span>
     <span class="s4">* otherwise, this class loader's default assertion status is returned.</span>
     <span class="s4">* </span><span class="s6">&lt;/p&gt;</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@param  </span><span class="s4">className</span>
     <span class="s4">*         The fully qualified class name of the class whose desired</span>
     <span class="s4">*         assertion status is being queried.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@return  </span><span class="s4">The desired assertion status of the specified class.</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#setClassAssertionStatus(String, boolean)</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#setPackageAssertionStatus(String, boolean)</span>
     <span class="s4">* </span><span class="s5">@see  </span><span class="s4">#setDefaultAssertionStatus(boolean)</span>
     <span class="s4">*</span>
     <span class="s4">* </span><span class="s5">@since  </span><span class="s4">1.4</span>
     <span class="s4">*/</span>
    <span class="s2">boolean </span><span class="s1">desiredAssertionStatus</span><span class="s3">(</span><span class="s1">String className</span><span class="s3">) {</span>
        <span class="s2">synchronized </span><span class="s3">(</span><span class="s1">assertionLock</span><span class="s3">) {</span>
            <span class="s0">// assert classAssertionStatus   != null;</span>
            <span class="s0">// assert packageAssertionStatus != null;</span>

            <span class="s0">// Check for a class entry</span>
            <span class="s1">Boolean result </span><span class="s3">= </span><span class="s1">classAssertionStatus</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">className</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">result </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">)</span>
                <span class="s2">return </span><span class="s1">result</span><span class="s3">.</span><span class="s1">booleanValue</span><span class="s3">();</span>

            <span class="s0">// Check for most specific package entry</span>
            <span class="s2">int </span><span class="s1">dotIndex </span><span class="s3">= </span><span class="s1">className</span><span class="s3">.</span><span class="s1">lastIndexOf</span><span class="s3">(</span><span class="s8">'.'</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">dotIndex </span><span class="s3">&lt; </span><span class="s7">0</span><span class="s3">) { </span><span class="s0">// default package</span>
                <span class="s1">result </span><span class="s3">= </span><span class="s1">packageAssertionStatus</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s2">null</span><span class="s3">);</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">result </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">)</span>
                    <span class="s2">return </span><span class="s1">result</span><span class="s3">.</span><span class="s1">booleanValue</span><span class="s3">();</span>
            <span class="s3">}</span>
            <span class="s2">while</span><span class="s3">(</span><span class="s1">dotIndex </span><span class="s3">&gt; </span><span class="s7">0</span><span class="s3">) {</span>
                <span class="s1">className </span><span class="s3">= </span><span class="s1">className</span><span class="s3">.</span><span class="s1">substring</span><span class="s3">(</span><span class="s7">0</span><span class="s3">, </span><span class="s1">dotIndex</span><span class="s3">);</span>
                <span class="s1">result </span><span class="s3">= </span><span class="s1">packageAssertionStatus</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">className</span><span class="s3">);</span>
                <span class="s2">if </span><span class="s3">(</span><span class="s1">result </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">)</span>
                    <span class="s2">return </span><span class="s1">result</span><span class="s3">.</span><span class="s1">booleanValue</span><span class="s3">();</span>
                <span class="s1">dotIndex </span><span class="s3">= </span><span class="s1">className</span><span class="s3">.</span><span class="s1">lastIndexOf</span><span class="s3">(</span><span class="s8">'.'</span><span class="s3">, </span><span class="s1">dotIndex</span><span class="s3">-</span><span class="s7">1</span><span class="s3">);</span>
            <span class="s3">}</span>

            <span class="s0">// Return the classloader default</span>
            <span class="s2">return </span><span class="s1">defaultAssertionStatus</span><span class="s3">;</span>
        <span class="s3">}</span>
    <span class="s3">}</span>

    <span class="s0">// Set up the assertions with information provided by the VM.</span>
    <span class="s0">// Note: Should only be called inside a synchronized block</span>
    <span class="s2">private void </span><span class="s1">initializeJavaAssertionMaps</span><span class="s3">() {</span>
        <span class="s0">// assert Thread.holdsLock(assertionLock);</span>

        <span class="s1">classAssertionStatus </span><span class="s3">= </span><span class="s2">new </span><span class="s1">HashMap</span><span class="s3">&lt;&gt;();</span>
        <span class="s1">packageAssertionStatus </span><span class="s3">= </span><span class="s2">new </span><span class="s1">HashMap</span><span class="s3">&lt;&gt;();</span>
        <span class="s1">AssertionStatusDirectives directives </span><span class="s3">= </span><span class="s1">retrieveDirectives</span><span class="s3">();</span>

        <span class="s2">for</span><span class="s3">(</span><span class="s2">int </span><span class="s1">i </span><span class="s3">= </span><span class="s7">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">classes</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++)</span>
            <span class="s1">classAssertionStatus</span><span class="s3">.</span><span class="s1">put</span><span class="s3">(</span><span class="s1">directives</span><span class="s3">.</span><span class="s1">classes</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span>
                                     <span class="s1">directives</span><span class="s3">.</span><span class="s1">classEnabled</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]);</span>

        <span class="s2">for</span><span class="s3">(</span><span class="s2">int </span><span class="s1">i </span><span class="s3">= </span><span class="s7">0</span><span class="s3">; </span><span class="s1">i </span><span class="s3">&lt; </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">packages</span><span class="s3">.</span><span class="s1">length</span><span class="s3">; </span><span class="s1">i</span><span class="s3">++)</span>
            <span class="s1">packageAssertionStatus</span><span class="s3">.</span><span class="s1">put</span><span class="s3">(</span><span class="s1">directives</span><span class="s3">.</span><span class="s1">packages</span><span class="s3">[</span><span class="s1">i</span><span class="s3">],</span>
                                       <span class="s1">directives</span><span class="s3">.</span><span class="s1">packageEnabled</span><span class="s3">[</span><span class="s1">i</span><span class="s3">]);</span>

        <span class="s1">defaultAssertionStatus </span><span class="s3">= </span><span class="s1">directives</span><span class="s3">.</span><span class="s1">deflt</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// Retrieves the assertion directives from the VM.</span>
    <span class="s2">private static native </span><span class="s1">AssertionStatusDirectives retrieveDirectives</span><span class="s3">();</span>


    <span class="s0">// -- Misc --</span>

    <span class="s4">/**</span>
     <span class="s4">* Returns the ConcurrentHashMap used as a storage for ClassLoaderValue(s)</span>
     <span class="s4">* associated with this ClassLoader, creating it if it doesn't already exist.</span>
     <span class="s4">*/</span>
    <span class="s1">ConcurrentHashMap</span><span class="s3">&lt;?, ?&gt; </span><span class="s1">createOrGetClassLoaderValueMap</span><span class="s3">() {</span>
        <span class="s1">ConcurrentHashMap</span><span class="s3">&lt;?, ?&gt; </span><span class="s1">map </span><span class="s3">= </span><span class="s1">classLoaderValueMap</span><span class="s3">;</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">map </span><span class="s3">== </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">map </span><span class="s3">= </span><span class="s2">new </span><span class="s1">ConcurrentHashMap</span><span class="s3">&lt;&gt;();</span>
            <span class="s2">boolean </span><span class="s1">set </span><span class="s3">= </span><span class="s1">trySetObjectField</span><span class="s3">(</span><span class="s8">&quot;classLoaderValueMap&quot;</span><span class="s3">, </span><span class="s1">map</span><span class="s3">);</span>
            <span class="s2">if </span><span class="s3">(!</span><span class="s1">set</span><span class="s3">) {</span>
                <span class="s0">// beaten by someone else</span>
                <span class="s1">map </span><span class="s3">= </span><span class="s1">classLoaderValueMap</span><span class="s3">;</span>
            <span class="s3">}</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">map</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s0">// the storage for ClassLoaderValue(s) associated with this ClassLoader</span>
    <span class="s2">private volatile </span><span class="s1">ConcurrentHashMap</span><span class="s3">&lt;?, ?&gt; </span><span class="s1">classLoaderValueMap</span><span class="s3">;</span>

    <span class="s4">/**</span>
     <span class="s4">* Attempts to atomically set a volatile field in this object. Returns</span>
     <span class="s4">* {</span><span class="s5">@code </span><span class="s4">true} if not beaten by another thread. Avoids the use of</span>
     <span class="s4">* AtomicReferenceFieldUpdater in this class.</span>
     <span class="s4">*/</span>
    <span class="s2">private boolean </span><span class="s1">trySetObjectField</span><span class="s3">(</span><span class="s1">String name</span><span class="s3">, </span><span class="s1">Object obj</span><span class="s3">) {</span>
        <span class="s1">Unsafe unsafe </span><span class="s3">= </span><span class="s1">Unsafe</span><span class="s3">.</span><span class="s1">getUnsafe</span><span class="s3">();</span>
        <span class="s1">Class</span><span class="s3">&lt;?&gt; </span><span class="s1">k </span><span class="s3">= </span><span class="s1">ClassLoader</span><span class="s3">.</span><span class="s2">class</span><span class="s3">;</span>
        <span class="s2">long </span><span class="s1">offset</span><span class="s3">;</span>
        <span class="s1">offset </span><span class="s3">= </span><span class="s1">unsafe</span><span class="s3">.</span><span class="s1">objectFieldOffset</span><span class="s3">(</span><span class="s1">k</span><span class="s3">, </span><span class="s1">name</span><span class="s3">);</span>
        <span class="s2">return </span><span class="s1">unsafe</span><span class="s3">.</span><span class="s1">compareAndSetReference</span><span class="s3">(</span><span class="s2">this</span><span class="s3">, </span><span class="s1">offset</span><span class="s3">, </span><span class="s2">null</span><span class="s3">, </span><span class="s1">obj</span><span class="s3">);</span>
    <span class="s3">}</span>

    <span class="s4">/**</span>
     <span class="s4">* Called by the VM, during -Xshare:dump</span>
     <span class="s4">*/</span>
    <span class="s2">private void </span><span class="s1">resetArchivedStates</span><span class="s3">() {</span>
        <span class="s2">if </span><span class="s3">(</span><span class="s1">parallelLockMap </span><span class="s3">!= </span><span class="s2">null</span><span class="s3">) {</span>
            <span class="s1">parallelLockMap</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">();</span>
        <span class="s3">}</span>
        <span class="s1">packages</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">();</span>
        <span class="s1">package2certs</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">();</span>
        <span class="s1">classes</span><span class="s3">.</span><span class="s1">clear</span><span class="s3">();</span>
        <span class="s1">classLoaderValueMap </span><span class="s3">= </span><span class="s2">null</span><span class="s3">;</span>
    <span class="s3">}</span>
<span class="s3">}</span>

<span class="s0">/* 
 * A utility class that will enumerate over an array of enumerations. 
 */</span>
<span class="s2">final class </span><span class="s1">CompoundEnumeration</span><span class="s3">&lt;</span><span class="s1">E</span><span class="s3">&gt; </span><span class="s2">implements </span><span class="s1">Enumeration</span><span class="s3">&lt;</span><span class="s1">E</span><span class="s3">&gt; {</span>
    <span class="s2">private final </span><span class="s1">Enumeration</span><span class="s3">&lt;</span><span class="s1">E</span><span class="s3">&gt;[] </span><span class="s1">enums</span><span class="s3">;</span>
    <span class="s2">private int </span><span class="s1">index</span><span class="s3">;</span>

    <span class="s2">public </span><span class="s1">CompoundEnumeration</span><span class="s3">(</span><span class="s1">Enumeration</span><span class="s3">&lt;</span><span class="s1">E</span><span class="s3">&gt;[] </span><span class="s1">enums</span><span class="s3">) {</span>
        <span class="s2">this</span><span class="s3">.</span><span class="s1">enums </span><span class="s3">= </span><span class="s1">enums</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">private boolean </span><span class="s1">next</span><span class="s3">() {</span>
        <span class="s2">while </span><span class="s3">(</span><span class="s1">index </span><span class="s3">&lt; </span><span class="s1">enums</span><span class="s3">.</span><span class="s1">length</span><span class="s3">) {</span>
            <span class="s2">if </span><span class="s3">(</span><span class="s1">enums</span><span class="s3">[</span><span class="s1">index</span><span class="s3">] != </span><span class="s2">null </span><span class="s3">&amp;&amp; </span><span class="s1">enums</span><span class="s3">[</span><span class="s1">index</span><span class="s3">].</span><span class="s1">hasMoreElements</span><span class="s3">()) {</span>
                <span class="s2">return true</span><span class="s3">;</span>
            <span class="s3">}</span>
            <span class="s1">index</span><span class="s3">++;</span>
        <span class="s3">}</span>
        <span class="s2">return false</span><span class="s3">;</span>
    <span class="s3">}</span>

    <span class="s2">public boolean </span><span class="s1">hasMoreElements</span><span class="s3">() {</span>
        <span class="s2">return </span><span class="s1">next</span><span class="s3">();</span>
    <span class="s3">}</span>

    <span class="s2">public </span><span class="s1">E nextElement</span><span class="s3">() {</span>
        <span class="s2">if </span><span class="s3">(!</span><span class="s1">next</span><span class="s3">()) {</span>
            <span class="s2">throw new </span><span class="s1">NoSuchElementException</span><span class="s3">();</span>
        <span class="s3">}</span>
        <span class="s2">return </span><span class="s1">enums</span><span class="s3">[</span><span class="s1">index</span><span class="s3">].</span><span class="s1">nextElement</span><span class="s3">();</span>
    <span class="s3">}</span>
<span class="s3">}</span>
</pre>
</body>
</html>